<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Waterstrong Blog</title>
  <subtitle>Enjoy this moment!</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.waterstrong.me/"/>
  <updated>2017-03-18T15:42:08.000Z</updated>
  <id>http://blog.waterstrong.me/</id>
  
  <author>
    <name>Waterstrong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何创建Git服务器仓库</title>
    <link href="http://blog.waterstrong.me/git-server-repository/"/>
    <id>http://blog.waterstrong.me/git-server-repository/</id>
    <published>2017-02-15T14:35:49.000Z</published>
    <updated>2017-03-18T15:42:08.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;序&quot;&gt;&lt;a href=&quot;#序&quot; class=&quot;headerlink&quot; title=&quot;序&quot;&gt;&lt;/a&gt;序&lt;/h2&gt;&lt;p&gt;在使用Git时，通常会选择使用一个项目代码托管平台，这样的平台可以有很多选择，比如目前最流行的面向开源及私有软件项目的托管平台是&lt;a href=&quot;https://github.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub&lt;/a&gt;，还有一些其他优秀的平台，如Atlassian的&lt;a href=&quot;https://bitbucket.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Bitbucket&lt;/a&gt;、&lt;a href=&quot;https://gitlab.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitLab&lt;/a&gt;、&lt;a href=&quot;https://coding.net&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Coding.NET&lt;/a&gt;、开源中国的&lt;a href=&quot;http://git.oschina.net/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;码云&lt;/a&gt;、&lt;a href=&quot;https://code.csdn.net/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CSDN.NET&lt;/a&gt;等，不仅可以使用Public和Private服务，还可以付费搭建定制服务，不过有些跑题了，本文中只关注使用简单的命令快速搭建共享服务器仓库。另外，关于Git的使用，可以参阅 &lt;a href=&quot;http://blog.waterstrong.me/master-git/&quot;&gt;优雅地使用Git&lt;/a&gt; 了解更多内容，这里也不会再涉及Git命令细节。&lt;/p&gt;
&lt;h2 id=&quot;创建服务器仓库&quot;&gt;&lt;a href=&quot;#创建服务器仓库&quot; class=&quot;headerlink&quot; title=&quot;创建服务器仓库&quot;&gt;&lt;/a&gt;创建服务器仓库&lt;/h2&gt;&lt;p&gt;先创建一个文件夹名为&lt;code&gt;demo.git&lt;/code&gt;，在其中使用命令创建裸仓库(作为服务器仓库)：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git init --bare&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &amp;gt; ls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# HEAD  branches  config  description  hooks  info  objects  refs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# &amp;gt; tree -a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── HEAD 	# 指向当前所处的分支&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── branches	# 包含的Git分支信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── config	# Git仓库的配置文件&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── description	# Git仓库的描述信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── hooks	# 一些shell钩子脚本&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── applypatch-msg.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── commit-msg.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── post-update.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── pre-applypatch.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── pre-commit.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── pre-push.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── pre-rebase.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── prepare-commit-msg.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   └── update.sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── info	# 包含仓库的一些信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   └── exclude&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── objects	# Git仓库的所有对象&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   ├── info&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   └── pack&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└── refs 	# 标识分支指向的提交&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── heads&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    └── tags&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;与使用&lt;code&gt;git init&lt;/code&gt;命令创建的目录不太一样，其中并没有&lt;code&gt;.git&lt;/code&gt;目录，而是直接在工程目录下列出了其他的目录，并且可以查看到&lt;code&gt;config&lt;/code&gt;中的内容&lt;code&gt;bare=true&lt;/code&gt;：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[core]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	repositoryformatversion = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	filemode = true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	bare = true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ignorecase = true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	precomposeunicode = true&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果期望将普通的Git仓库转换为服务器仓库，可以使用如下命令进行转换，克隆出&lt;code&gt;.git&lt;/code&gt;内容作为服务器仓库：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone --bare xxx&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中，bare仓库不包含工作区，目录中不包括项目源代码，不能直接在bare仓库上直接提交变更。&lt;/p&gt;
&lt;h2 id=&quot;连接服务器仓库&quot;&gt;&lt;a href=&quot;#连接服务器仓库&quot; class=&quot;headerlink&quot; title=&quot;连接服务器仓库&quot;&gt;&lt;/a&gt;连接服务器仓库&lt;/h2&gt;&lt;p&gt;假设在本地文件系统中创建，目录位置为&lt;code&gt;~/Documents/git-server/demo.git&lt;/code&gt;，则可以使用以下命令克隆或关联服务器仓库：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone ~/Documents/git-server/demo.git  # 直接clone代码，本地可不用加user@localhost&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git remote add origin ~/Documents/git-server/demo.git  # 或是添加为远程origin&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果是使用AWS的EC2这样的服务，若文件目录位置为&lt;code&gt;/home/ec2-user/projects/git-repo.git&lt;/code&gt;，服务器地址为&lt;code&gt;aws.waterstrong.me&lt;/code&gt;，用户名为&lt;code&gt;ec2-user&lt;/code&gt;，则同样可以克隆或关联远程仓库：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone ec2-user@aws.waterstrong.me:/home/ec2-user/projects/git-repo.git  # 直接clone&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git remote add origin ec2-user@aws.waterstrong.me:/home/ec2-user/projects/git-repo.git  # 或添加origin&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在创建bare仓库时，可以在给文件目录命名时加上&lt;code&gt;.git&lt;/code&gt;后缀，也符合平常使用Git地址的习惯，这样，就可以像平常一样使用Git操作了。&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;p&gt;平时在使用&lt;code&gt;git init&lt;/code&gt;命令时，是初始化一个普通的Git本地仓库，而为了创建服务器仓库，可以使用&lt;code&gt;git init --bare &amp;lt;repo&amp;gt;&lt;/code&gt;命令，bare仓库没有工作区，不能对其直接提交变更，但可以被正常地clone, push, pull等操作。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://git-scm.com/docs/git-init&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;git document&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.saintsjd.com/2011/01/what-is-a-bare-git-repository/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;What is a bare git repository?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://about.gitlab.com/downloads/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitLab CE Package&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      在使用Git时，通常会选择使用一个项目代码托管平台，这样的平台可以有很多选择，如GitHub、Bitbucket、GitLab、Coding.NET、OSChina.NET、CSDN.NET等，不过，本文中只关注使用简单的Git命令快速搭建共享服务器仓库。
    
    </summary>
    
      <category term="Tools" scheme="http://blog.waterstrong.me/categories/Tools/"/>
    
    
      <category term="Git" scheme="http://blog.waterstrong.me/tags/Git/"/>
    
      <category term="VCS" scheme="http://blog.waterstrong.me/tags/VCS/"/>
    
      <category term="Repository" scheme="http://blog.waterstrong.me/tags/Repository/"/>
    
  </entry>
  
  <entry>
    <title>如何从SVN迁移源码到Git仓库</title>
    <link href="http://blog.waterstrong.me/svn-to-git-migration/"/>
    <id>http://blog.waterstrong.me/svn-to-git-migration/</id>
    <published>2017-02-10T14:51:30.000Z</published>
    <updated>2017-03-04T09:39:46.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;背景介绍&quot;&gt;&lt;a href=&quot;#背景介绍&quot; class=&quot;headerlink&quot; title=&quot;背景介绍&quot;&gt;&lt;/a&gt;背景介绍&lt;/h2&gt;&lt;p&gt;这里就不再赘述关于SVN与Git的区别以及为什么要迁移源码到Git了，毕竟Git是当前的主流DVCS了，而且已经公认地非常好用，如果你还在使用SVN的话该考虑换了，是时候迁移那些遗留代码了，有兴趣可以参阅 &lt;a href=&quot;https://www.atlassian.com/git/tutorials/why-git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Why Git&lt;/a&gt; 和 &lt;a href=&quot;https://www.atlassian.com/git/tutorials/perforce-git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Perforce to Git&lt;/a&gt; 了解更多。通常来说，在项目开发过程中，难免会遇到一些老项目代码正被SVN管理着，但基于当下诸多原因，或是扩展开发，或是战略转移，或是为了更好地开发体验，需要将这些在维护的遗留项目源码迁移为Git管理。那如何有效地迁移源码？并且如何保留提交记录、分支记录以及开发成员等信息呢？笔者前一段时间就经历了这样的迁移工作，还是有必要分享一下，也算是一种总结了。&lt;/p&gt;
&lt;h2 id=&quot;准备工作&quot;&gt;&lt;a href=&quot;#准备工作&quot; class=&quot;headerlink&quot; title=&quot;准备工作&quot;&gt;&lt;/a&gt;准备工作&lt;/h2&gt;&lt;p&gt;迁移SVN源码到Git仓库的方法肯定不是暴力地将代码Copy再Paste到Git仓库，也不是直接在项目下git init初始化仓库的，而是应该使用&lt;a href=&quot;https://git-scm.com/docs/git-svn&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;git svn&lt;/a&gt;命令操作实现迁移工作。那git-svn命令如何使用？有哪些注意事项呢？&lt;/p&gt;
&lt;p&gt;首先，在正式开始迁移项目之前，需要做一些准备工作：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;准备一台安装有最新Git环境的磁盘容量足的电脑&lt;/li&gt;
&lt;li&gt;已经获知Git仓库的远程地址，无论是自己创建还是团队提供&lt;/li&gt;
&lt;li&gt;确保对Git远程仓库有读写权限，无论通过用户名密码还是SSH访问都行&lt;/li&gt;
&lt;li&gt;准备一份开发者的SVN用户名到Git全名+邮件的映射关系列表文件authors.txt，格式为：&lt;code&gt;loginname = Username &amp;lt;user@example.com&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;由于SVN对每次提交只记录开发者的用户名，而Git存储其全名和邮件地址，这意味着需要对开发者信息进行映射转换，在准备&lt;code&gt;authors.txt&lt;/code&gt;文件时，可以到团队系统数据库直接查询开发者&lt;em&gt;登录名、用户名和邮件地址&lt;/em&gt;并拼接成指定的格式，或者可下载&lt;em&gt;Atlassian&lt;/em&gt;的工具包&lt;a href=&quot;https://bitbucket.org/atlassian/svn-migration-scripts/downloads&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;svn-migration-scripts.jar&lt;/a&gt;，通过命令拉取SVN仓库的用户并生成对应的开发者信息映射文件，需要Java运行时环境支持：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;java -jar svn-migration-scripts.jar authors https://svn.example.com &amp;gt; authors.txt&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;转换仓库&quot;&gt;&lt;a href=&quot;#转换仓库&quot; class=&quot;headerlink&quot; title=&quot;转换仓库&quot;&gt;&lt;/a&gt;转换仓库&lt;/h2&gt;&lt;p&gt;准备工作完成后可以开始实施转移仓库了，应该注意的是，在转移SVN项目时需要根据是否是标准的SVN文件布局来确定命令行的参数。（注：以下所有示意图均来自Atlassian）&lt;/p&gt;
&lt;h4 id=&quot;标准的SVN文件布局&quot;&gt;&lt;a href=&quot;#标准的SVN文件布局&quot; class=&quot;headerlink&quot; title=&quot;标准的SVN文件布局&quot;&gt;&lt;/a&gt;标准的SVN文件布局&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/assets/master-git/standard_svn_repo.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果SVN仓库使用标准的了&lt;code&gt;/trunk&lt;/code&gt;, &lt;code&gt;/branches&lt;/code&gt;和&lt;code&gt;/tags&lt;/code&gt;的目录结构，就可在运行命令时加上参数&lt;code&gt;--stdlayout&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git svn clone --stdlayout --authors-file=authors.txt &amp;lt;svn-repo&amp;gt;/&amp;lt;project&amp;gt; &amp;lt;git-repo-name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git svn clone --stdlayout --authors-file=authors.txt https://svn.waterstrong.com/demo demo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;非标准的的SVN文件布局&quot;&gt;&lt;a href=&quot;#非标准的的SVN文件布局&quot; class=&quot;headerlink&quot; title=&quot;非标准的的SVN文件布局&quot;&gt;&lt;/a&gt;非标准的的SVN文件布局&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/assets/master-git/nonstandard_svn_repo.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果SVN仓库是非标准的目录布局，那就需要分别显示指定参数&lt;code&gt;--trunk, --branches, --tags&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git svn clone --trunk=/trunk --branches=/branches --branches=/bugfixes --tags=/tags --authors-file=authors.txt &amp;lt;svn-repo&amp;gt;/&amp;lt;project&amp;gt; &amp;lt;git-repo-name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;Authors文件的使用&quot;&gt;&lt;a href=&quot;#Authors文件的使用&quot; class=&quot;headerlink&quot; title=&quot;Authors文件的使用&quot;&gt;&lt;/a&gt;Authors文件的使用&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;--authors-file&lt;/code&gt;：在之前的命令中已经提到需要添加参数&lt;code&gt;--authors-file=&amp;lt;filename&amp;gt;&lt;/code&gt;读取开发者信息映射文件，文件内容格式为&lt;code&gt;loginname = Username &amp;lt;user@example.com&amp;gt;&lt;/code&gt;，但如果在文件中不存SVN某个用户名的对应关系，那么git svn操作会被自动中止，因此，必须在&lt;code&gt;authors.txt&lt;/code&gt;文件中添加丢失的用户对应关系，然后重新运行git svn命令即可。配置其git config时的key为&lt;code&gt;svn.authorsfile&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--authors-prog&lt;/code&gt;：但如果希望在使用authors.txt文件时，即使某个SVN用户名对应关系不存在，命令也可以执行成功并自动使用默认值，可以使用该参数&lt;code&gt;--authors-prog=&amp;lt;filename&amp;gt;&lt;/code&gt;。配置其git config时的key为&lt;code&gt;svn.authorsProg&lt;/code&gt;，另外，可以在&lt;a href=&quot;https://www.atlassian.com/git/tutorials/migrating-synchronize&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Tutorials - Synchronize&lt;/a&gt;中找到关于authors文件的更多使用信息。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;大仓库的转换策略&quot;&gt;&lt;a href=&quot;#大仓库的转换策略&quot; class=&quot;headerlink&quot; title=&quot;大仓库的转换策略&quot;&gt;&lt;/a&gt;大仓库的转换策略&lt;/h4&gt;&lt;p&gt;特别注意的是，当SVN仓库非常非常大时，据官方统计数据，若转换拥有33000个提交的400MB大小的仓库需要花12个小时来完成转换。因此，在这种情况下，可以选择找一台机器，运行命令后就不管了直到完成转换为止，或者是选择放弃保存非常老的提交历史记录，这样可以加速转换过程，如果转换时只保留部分提交历史的话可以使用以下命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git svn clone -r$&amp;#123;REVNUMBER&amp;#125;:HEAD --stdlayout --authors-file=authors.txt &amp;lt;svn-repo&amp;gt;/&amp;lt;project&amp;gt; &amp;lt;git-repo-name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git svn clone -r19698:HEAD --stdlayout --authors-file=authors.txt https://svn.waterstrong.com/demo demo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;清理仓库&quot;&gt;&lt;a href=&quot;#清理仓库&quot; class=&quot;headerlink&quot; title=&quot;清理仓库&quot;&gt;&lt;/a&gt;清理仓库&lt;/h2&gt;&lt;p&gt;至此，SVN到Git的转换工作接近尾声，如果只是关注 &lt;strong&gt;trunk&lt;/strong&gt; 和 &lt;strong&gt;master&lt;/strong&gt; 主分支，那么可以不用在意清理仓库这一部分的内容了，可以直接跳过进入下一节，如果需要清理并将分支和标签进行本地化，则可以关注一下本节内容。&lt;/p&gt;
&lt;p&gt;对于SVN的分支和标签，转换操作是不会将其导入到新的Git仓库中，而且在Git分支中也找不到SVN的分支branch，也找不到对应的标签tag，不过可以使用命令&lt;code&gt;git branch -r&lt;/code&gt;可以查看到所有SVN的分支和标签，这是因为在使用&lt;code&gt;git svn clone&lt;/code&gt;命令时会将SVN的分支和标签导入为Git的远程分支和标签，如下示意图所示。&lt;br&gt;&lt;img src=&quot;/assets/master-git/repo_structure.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;该策略主要是为SVN与Git双向同步服务的，但通常SVN单向转换到Git后都会直接使用Git了，并且会禁止SVN提交了，所以还是会对分支和标签内容进行清理以转换为Git的分支和标签。可以使用Atlassian提供的脚本工具快速实现对仓库分支和标签的清理工作：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;java -Dfile.encoding=utf-8 -jar svn-migration-scripts.jar clean-git --force&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;将SVN分支和标签转换Git的本地分支和标签后结构如下图所示：&lt;br&gt;&lt;img src=&quot;/assets/master-git/local_git_repo.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;收尾工作&quot;&gt;&lt;a href=&quot;#收尾工作&quot; class=&quot;headerlink&quot; title=&quot;收尾工作&quot;&gt;&lt;/a&gt;收尾工作&lt;/h2&gt;&lt;p&gt;完成以上步骤后，迁移工作基本完成，接下来需要根据项目代码性质、团队约定等情况做一些收尾工作，需要具体情况具体分析。这里会以一个Gradle构建的Java项目(IDE使用IntelliJ)为例介绍从SVN迁移到Git后的收尾工作：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;查看Git远程地址是否已经配置了，如果还没有配置，可以使用命令&lt;code&gt;git remote&lt;/code&gt;命令配置&lt;code&gt;origin&lt;/code&gt;，比较常用的两组命令为：&lt;/p&gt;
 &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git remote add origin xxx  # 添加新的远程地址&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git remote set-url origin xxx  # 修改origin的远程地址&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用命令&lt;code&gt;git update-index&lt;/code&gt;配置构建工具的执行权限，如果有其他执行脚本也需要配置相应权限信息：&lt;/p&gt;
 &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git update-index --chmod=+x gradlew&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git update-index --chmod=+x gradlew.bat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git update-index --chmod=+x xxx.sh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;添加&lt;code&gt;.gitignore&lt;/code&gt;文件，根据不同的项目写入要忽略的文件，如Java项目ignore文件会包括：&lt;/p&gt;
 &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/out&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/build&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/.idea&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.gradle&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.DS_Store&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*.iml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*.ipr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*.iws&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;更新IDE的vcs配置为Git而非Svn，在&lt;code&gt;build.gradle&lt;/code&gt;文件修改vcs配置：&lt;/p&gt;
 &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;idea.project.vcs = &amp;quot;Git&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;最后上传到Repo，并根据团队内部的约定设置相应的权限，通常会有一个检查清单，比如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;设置分支模型&lt;/li&gt;
&lt;li&gt;添加分支权限&lt;/li&gt;
&lt;li&gt;限定PR合并权限&lt;/li&gt;
&lt;li&gt;配置SVN提交通知&lt;/li&gt;
&lt;li&gt;变更CI拉取代码地址&lt;/li&gt;
&lt;li&gt;……&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;结语&quot;&gt;&lt;a href=&quot;#结语&quot; class=&quot;headerlink&quot; title=&quot;结语&quot;&gt;&lt;/a&gt;结语&lt;/h2&gt;&lt;p&gt;总得来说，从SVN迁移源码到Git仓库包括：准备工作、转换仓库、清理仓库以及收尾工作，其中清理仓库部分可以跳过，其他部分是需要完成的，还必须注意SVN文件布局以及正确地使用authors文件，同时，要考虑在遇到大仓库时应根据实际情况采用相对适合的迁移策略，最后，应遵循团队的约定，对照检查清单完成所有收尾工作。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.atlassian.com/git/tutorials/migrating-convert&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Migrate to Git from SVN&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://git-scm.com/docs/git-svn&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;git-svn docs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      在项目开发过程中，难免会遇到老项目的代码是被SVN管理的，但基于当下诸多原因，或是扩展开发，或是战略转移，或是为了更好地开发体验，需要将这些在维护的遗留项目源码迁移为Git管理。那如何有效地迁移源码并保留历史记录呢？
    
    </summary>
    
      <category term="Tools" scheme="http://blog.waterstrong.me/categories/Tools/"/>
    
    
      <category term="Git" scheme="http://blog.waterstrong.me/tags/Git/"/>
    
      <category term="VCS" scheme="http://blog.waterstrong.me/tags/VCS/"/>
    
      <category term="SVN" scheme="http://blog.waterstrong.me/tags/SVN/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQ项目实践应用 - 发布订阅模式</title>
    <link href="http://blog.waterstrong.me/rabbitmq-in-project/"/>
    <id>http://blog.waterstrong.me/rabbitmq-in-project/</id>
    <published>2016-11-01T15:26:31.000Z</published>
    <updated>2016-11-07T14:58:23.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;一、需求描述&quot;&gt;&lt;a href=&quot;#一、需求描述&quot; class=&quot;headerlink&quot; title=&quot;一、需求描述&quot;&gt;&lt;/a&gt;一、需求描述&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;背景&lt;/strong&gt;&lt;br&gt;&lt;em&gt;当前有一个源系统G，主要存储大量数据，每条数据以唯一的ID标识，该系统每天会不定时处理一些合并数据的操作，出于某些需求原因，同时还有若干下游子系统A，其中保存了源系统数据的主键ID。&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;需求&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当源系统G发生了合并操作时需要通知所有下游子系统对相同ID的数据进行相应的更改&lt;/li&gt;
&lt;li&gt;下游子系统数量不定，且可能在以后会逐渐增加，应尽可能降低源系统和子系统间的耦合&lt;/li&gt;
&lt;li&gt;特别是在增加下游子系统时不需要修改源系统的代码就可完成通知的功能&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;二、解决方案&quot;&gt;&lt;a href=&quot;#二、解决方案&quot; class=&quot;headerlink&quot; title=&quot;二、解决方案&quot;&gt;&lt;/a&gt;二、解决方案&lt;/h3&gt;&lt;p&gt;考虑到解耦，比较理想的方案是采用消息机制来实现，可以通过将源系统G的合并操作转化为消息发送给一个Exchange，然后由Exchange分发给每个下游子系统对应的Queue，由子系统各自独立处理并维护队列消息，这样，当增加一个子系统时，只需要添加一个Queue并绑定到Exchange上即可，很符合发布订阅模式，可以参阅之前博客 &lt;a href=&quot;/rabbitmq-start-guide&quot;&gt;RabbitMQ入门指南&lt;/a&gt; 中的场景三。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/publish_subscribe.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;三、方案实施&quot;&gt;&lt;a href=&quot;#三、方案实施&quot; class=&quot;headerlink&quot; title=&quot;三、方案实施&quot;&gt;&lt;/a&gt;三、方案实施&lt;/h3&gt;&lt;h5 id=&quot;管理RabbitMQ服务&quot;&gt;&lt;a href=&quot;#管理RabbitMQ服务&quot; class=&quot;headerlink&quot; title=&quot;管理RabbitMQ服务&quot;&gt;&lt;/a&gt;管理RabbitMQ服务&lt;/h5&gt;&lt;p&gt;在完成安装RabbitMQ后即可开始使用，这里采用虚拟机中Docker启动服务的方式，当前的虚拟机IP地址为&lt;code&gt;192.168.56.105&lt;/code&gt;，在后续的配置和访问中都会用到。通常在程序中用代码实现创建并绑定Exchange和Queue，但为了将Queue的管理和访问权限分离开来，这里采用事先创建Exchange和Queue，然后程序只负责配置连接访问对应的Exchange和Queue的方式。如果对RabbitMQ的相关配置和应用还不太了解，可以参阅另一篇博客 &lt;a href=&quot;/rabbitmq-professional&quot;&gt;RabbitMQ进阶指南&lt;/a&gt;。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;首先登录到&lt;a href=&quot;http://192.168.56.105:15672&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://192.168.56.105:15672&lt;/a&gt;，默认用户名和密码为&lt;code&gt;guest&lt;/code&gt;。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/overview_totals2.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;选择【channel】页，创建多个Queues，分别命名为&lt;code&gt;DEV.MESSAGE.QUEUE.APP1&lt;/code&gt;, &lt;code&gt;...APP2&lt;/code&gt;和&lt;code&gt;...APP3&lt;/code&gt;。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/queues.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;选择【exchanges】页，创建&lt;code&gt;topic&lt;/code&gt;类型的Exchange，命名为&lt;code&gt;DEV.MESSAGE.TOPIC.MAIN&lt;/code&gt;。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/exchanges.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;选择并点击【DEV.MESSAGE.TOPIC.MAIN】条目，进入详细页面，选择【Bindings】，将步骤2中的Queues绑定到该Exchange上。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/exchanges_topic.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这样，Exchange和Queue的创建及绑定工作就完成了，接下来需要分别完成发送者和接收者的代码。&lt;/p&gt;
&lt;h5 id=&quot;源系统发送消息&quot;&gt;&lt;a href=&quot;#源系统发送消息&quot; class=&quot;headerlink&quot; title=&quot;源系统发送消息&quot;&gt;&lt;/a&gt;源系统发送消息&lt;/h5&gt;&lt;p&gt;发送消息需要配置&lt;code&gt;ConnectionFactory&lt;/code&gt;关联到RabbitMQ服务，然后通过&lt;code&gt;RabbitTemplate&lt;/code&gt;发送消息到连接的Exchange中，这里选取&lt;code&gt;topic&lt;/code&gt;类型作为示例讲解，如果只是单纯的广播，采用最基本的&lt;code&gt;fanout&lt;/code&gt;类型也可以满足当前需求的，请根据项目的实际情况选用Exchange类型。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;figcaption&gt;&lt;span&gt;RabbitMqConfiguration.java&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; ws.message.configuration;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.rabbit.connection.AbstractConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.rabbit.connection.CachingConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.beans.factory.annotation.Value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.context.annotation.Bean;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.context.annotation.Configuration;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.rabbitmq.client.ConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Configuration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RabbitMqConfiguration&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.host&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String topicHost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.username&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String username;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.password&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String password;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.port:5672&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; port;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.virtualHost:/&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String virtualHost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.connectionTimeout&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; connectionTimeout;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.recoveryInterval&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; recoveryInterval;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Bean&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; AbstractConnectionFactory &lt;span class=&quot;title&quot;&gt;connectionFactory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ConnectionFactory factory = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ConnectionFactory();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setHost(topicHost);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setUsername(username);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setPassword(password);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setPort(port);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setVirtualHost(virtualHost);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setConnectionTimeout(connectionTimeout);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        factory.setNetworkRecoveryInterval(recoveryInterval);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; CachingConnectionFactory(factory);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在默认的&lt;code&gt;resources&lt;/code&gt;目录下创建&lt;code&gt;application.yml&lt;/code&gt;并添加需要的Properties，需要指定&lt;code&gt;host&lt;/code&gt;、&lt;code&gt;username&lt;/code&gt;、&lt;code&gt;password&lt;/code&gt;以及&lt;code&gt;topicName&lt;/code&gt;等配置参数，另外，&lt;code&gt;recoveryInterval&lt;/code&gt;表示网络恢复重试的时间间隔，&lt;code&gt;connectionTimeout&lt;/code&gt;表示连接超时，都以毫秒为单位。&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;figcaption&gt;&lt;span&gt;application.yml&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;server:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;8081&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  context-path:&lt;/span&gt; /producer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rabbitmq:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  host:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.56&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.105&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  username:&lt;/span&gt; guest&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  password:&lt;/span&gt; guest&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  topicName:&lt;/span&gt; DEV.MESSAGE.TOPIC.MAIN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  recoveryInterval:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  connectionTimeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最后创建&lt;code&gt;MessageController&lt;/code&gt;来模拟源系统的发送消息行为，采用&lt;code&gt;RabbitTemplate&lt;/code&gt;将消息发送到指定的Topic上。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;figcaption&gt;&lt;span&gt;MessageController.java&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; ws.message.controller;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; java.lang.String.format;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; org.apache.log4j.Logger.getLogger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; org.joda.time.DateTime.now;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; org.springframework.http.HttpStatus.CREATED;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; org.springframework.web.bind.annotation.RequestMethod.POST;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.apache.log4j.Logger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.rabbit.core.RabbitTemplate;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.beans.factory.annotation.Autowired;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.beans.factory.annotation.Value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.http.ResponseEntity;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.web.bind.annotation.RequestBody;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.web.bind.annotation.RequestMapping;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.web.bind.annotation.RestController;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@RestController&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MessageController&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; Logger LOGGER = getLogger(MessageController.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.topicName&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String topicName;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; RabbitTemplate rabbitTemplate;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@RequestMapping&lt;/span&gt;(method = POST, value = &lt;span class=&quot;string&quot;&gt;&quot;/messages&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;?&amp;gt; sendMessage(&lt;span class=&quot;meta&quot;&gt;@RequestBody&lt;/span&gt; String message)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        LOGGER.info(format(&lt;span class=&quot;string&quot;&gt;&quot;@%s Send message: %s&quot;&lt;/span&gt;, now(), message));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        rabbitTemplate.convertAndSend(topicName, &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;, message);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ResponseEntity&amp;lt;&amp;gt;(message, CREATED);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;完整代码可以参考GitHub Demo: &lt;a href=&quot;https://github.com/Waterstrong/message-producer&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;message-producer&lt;/a&gt;。&lt;/p&gt;
&lt;h5 id=&quot;子系统接收消息&quot;&gt;&lt;a href=&quot;#子系统接收消息&quot; class=&quot;headerlink&quot; title=&quot;子系统接收消息&quot;&gt;&lt;/a&gt;子系统接收消息&lt;/h5&gt;&lt;p&gt;需要配置连接的RabbitMQ服务和特定的Queue，该Queue是绑定在源系统的Exchange上的，同时需要设置消息监听者&lt;code&gt;RabbitMqConsumer&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;figcaption&gt;&lt;span&gt;RabbitMqConfiguration.java&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; ws.message.configuration;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.net.URI;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.rabbit.connection.CachingConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.rabbit.connection.ConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.beans.factory.annotation.Value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.context.annotation.Bean;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.context.annotation.Configuration;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ws.message.consumer.RabbitMqConsumer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Configuration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RabbitMqConfiguration&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.uri&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String rabbitUri;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;#&amp;#123;&#39;$&amp;#123;rabbitmq.queueNames&amp;#125;&#39;.split(&#39;,&#39;)&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String[] queueNames;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.recoveryInterval&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Long recoveryInterval;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;rabbitmq.receiveTimeout&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Long receiveTimeout;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Bean&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;SimpleMessageListenerContainer &lt;span class=&quot;title&quot;&gt;container&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ConnectionFactory connectionFactory,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                             RabbitMqConsumer messageListener,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                             MessageErrorHandler errorHandler)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        SimpleMessageListenerContainer container = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SimpleMessageListenerContainer();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setConnectionFactory(connectionFactory);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setQueueNames(queueNames);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setMessageListener(messageListener);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setRecoveryInterval(recoveryInterval);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setReceiveTimeout(receiveTimeout);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setDefaultRequeueRejected(&lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container.setErrorHandler(errorHandler);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; container;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Bean&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;ConnectionFactory &lt;span class=&quot;title&quot;&gt;connectionFactory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; CachingConnectionFactory(URI.create(rabbitUri));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中，&lt;code&gt;DefaultRequeueRejected&lt;/code&gt;如果被设置成&lt;code&gt;false&lt;/code&gt;，表示当出现异常时不会将消息保留在当前Queue中，如果设置为&lt;code&gt;true&lt;/code&gt;(默认值)，表示出错后会将消息保留在当前Queue中，并且应用程序会不停地读取消息，应根据实际需求处理，通常可以采用Dead Letter(死信)的方式处理，后续会详解。&lt;/p&gt;
&lt;p&gt;消息监听者&lt;code&gt;RabbitMqConsumer&lt;/code&gt;实现了&lt;code&gt;MessageListener&lt;/code&gt;接口，消息会被发送到&lt;code&gt;onMessage&lt;/code&gt;方法，子系统需要在这里处理接收到的消息。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;figcaption&gt;&lt;span&gt;RabbitMqConsumer.java&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; ws.message.consumer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; java.lang.String.format;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; org.apache.log4j.Logger.getLogger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; org.joda.time.DateTime.now;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.apache.log4j.Logger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.core.Message;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.amqp.core.MessageListener;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.beans.factory.annotation.Autowired;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.stereotype.Component;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.transaction.annotation.Transactional;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ws.message.repository.MessageRepository;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Component&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RabbitMqConsumer&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MessageListener&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; Logger LOGGER = getLogger(RabbitMqConsumer.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; MessageRepository messageRepository;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Transactional&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onMessage&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Message message)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String bodyContent = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; String(message.getBody());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        LOGGER.info(format(&lt;span class=&quot;string&quot;&gt;&quot;@@@@@@@@%s Received: %s\n&quot;&lt;/span&gt;, now(), bodyContent));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        messageRepository.save(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ws.message.entity.Message(bodyContent));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由于子系统处理完成消息后会与数据库进行交互，这里也会配置内存数据库来模拟实际行为，同时，需要设置&lt;code&gt;uri&lt;/code&gt;和&lt;code&gt;queueName&lt;/code&gt;，这里的uri是连接RabbitMQ的固定格式，也可以采用源系统配置中分开的写法，另外，&lt;code&gt;recoveryInterval&lt;/code&gt;表示Queue恢复重试的时间间隔，重试次数默认无限制，可以单独配置&lt;code&gt;FixedBackOff&lt;/code&gt;，&lt;code&gt;receiveTimeout&lt;/code&gt;接收消息超时时间，都以毫秒为单位。&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;figcaption&gt;&lt;span&gt;application.yml&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;server:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;8080&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  context-path:&lt;/span&gt; /consumer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spring:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  datasource:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; jdbc:h2:./.tmp/msgdb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    username:&lt;/span&gt; sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    password:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  jpa:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    show-sql:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    hibernate:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      ddl-auto:&lt;/span&gt; create-drop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rabbitmq:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  uri:&lt;/span&gt; amqp://guest:guest@&lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.56&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.105&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;5672&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  queueNames:&lt;/span&gt; DEV.MESSAGE.QUEUE.APP1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  recoveryInterval:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  receiveTimeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;完整代码可以参考GitHub Demo: &lt;a href=&quot;https://github.com/Waterstrong/message-consumer&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;message-consumer&lt;/a&gt;。&lt;/p&gt;
&lt;h5 id=&quot;全局事务处理&quot;&gt;&lt;a href=&quot;#全局事务处理&quot; class=&quot;headerlink&quot; title=&quot;全局事务处理&quot;&gt;&lt;/a&gt;全局事务处理&lt;/h5&gt;&lt;p&gt;既然这里涉及到消息机制和数据库的操作，必定需要考虑全局事务提交和回滚的情况，如果对事务还不太了解可以参阅之前的博客 &lt;a href=&quot;/xa-transactions-with-jta&quot;&gt;JTA实现分布式事务&lt;/a&gt; 和 &lt;a href=&quot;/transactional-mechanism-protocol&quot;&gt;事务处理机制与协议&lt;/a&gt;。在Spring Boot项目中，除了添加&lt;code&gt;spring-boot-starter-amqp&lt;/code&gt;和&lt;code&gt;spring-boot-starter-data-jpa&lt;/code&gt;依赖支持RabbitMQ消息和JPA数据库操作外，还需要添加&lt;code&gt;spring-boot-starter-jta-bitronix&lt;/code&gt;依赖引入&lt;code&gt;Bitronix&lt;/code&gt;支持全局事务机制，这样&lt;code&gt;DataSource&lt;/code&gt;和&lt;code&gt;ConnectionFactory&lt;/code&gt;会默认被加入到XA资源管理中。&lt;/p&gt;
&lt;p&gt;当子系统收到消息处理后，在准备保存数据库时发生了异常，消息和数据库都会被回滚，如果配置了&lt;code&gt;DefaultRequeueRejected&lt;/code&gt;为&lt;code&gt;false&lt;/code&gt;，消息会被立即丢弃或转到其他Queue上，当然可以在丢弃之前记录下日志或进行异常处理，该值默认会为&lt;code&gt;true&lt;/code&gt;，假设没有特殊配置，消息都会一直保留在当前Queue中，应用程序会一直不停读取消息，这样会阻塞后续的消息，因此必须设置消息在一定的重试次数后应被丢弃，一种常用的手段是为当前Queue配置&lt;code&gt;message-ttl&lt;/code&gt;和&lt;code&gt;dead-letter-exchange&lt;/code&gt;实现消息的超时和转发。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;message-ttl：一个消息在Queue上可以停留的时间，如果消息在规定时间内未消费将被视为超时过期并丢弃，时间单位为毫秒。&lt;/li&gt;
&lt;li&gt;dead-letter-exchange：可以为当前Queue配置某个Exchange或Queue，当消息被拒绝或过期时，消息会被转发到配置的Exchange上。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果配置了&lt;code&gt;dead-letter-exchange&lt;/code&gt;，那么可以设置在一定时间后再将消息以同样的形式返回到当前的Queue中，这样就实现了重试的机制，但该方法需要在消息头中记录重试的次数并用程序判断次数，以防止无限循环。&lt;/p&gt;
&lt;h3 id=&quot;结束语&quot;&gt;&lt;a href=&quot;#结束语&quot; class=&quot;headerlink&quot; title=&quot;结束语&quot;&gt;&lt;/a&gt;结束语&lt;/h3&gt;&lt;p&gt;在处理消息的回滚和重试时，可能还需要再寻求一些其他更好的技术解决方案，并且需要保证在应用程序或RabbitMQ服务器突然挂掉重启后，能够再次读取并处理之前失败的消息，只有当超过了一定的时间或重试次数时才将消息丢弃并将副本存在硬盘日志文件中。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.rabbitmq.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RabbitMQ Home&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.rabbitmq.com/getstarted.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RabbitMQ Tutorials&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://spring.io/guides/gs/messaging-rabbitmq/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Messaging with RabbitMQ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.waterstrong.me/transactional-mechanism-protocol/&quot;&gt;事务处理机制与协议&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.waterstrong.me/xa-transactions-with-jta/&quot;&gt;JTA实现分布式事务&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      当前有一个源系统G，主要存储大量数据，每条数据以唯一的ID标识，该系统每天会不定时处理一些合并数据的操作，出于某些需求原因，同时还有若干下游子系统A。
    
    </summary>
    
      <category term="Frameworks" scheme="http://blog.waterstrong.me/categories/Frameworks/"/>
    
    
      <category term="AMQP" scheme="http://blog.waterstrong.me/tags/AMQP/"/>
    
      <category term="RabbitMQ" scheme="http://blog.waterstrong.me/tags/RabbitMQ/"/>
    
      <category term="Message" scheme="http://blog.waterstrong.me/tags/Message/"/>
    
      <category term="Topic" scheme="http://blog.waterstrong.me/tags/Topic/"/>
    
      <category term="Exchange" scheme="http://blog.waterstrong.me/tags/Exchange/"/>
    
      <category term="Queue" scheme="http://blog.waterstrong.me/tags/Queue/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQ入门指南</title>
    <link href="http://blog.waterstrong.me/rabbitmq-start-guide/"/>
    <id>http://blog.waterstrong.me/rabbitmq-start-guide/</id>
    <published>2016-10-21T14:55:14.000Z</published>
    <updated>2016-11-07T14:53:18.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;RabbitMQ基本介绍&quot;&gt;&lt;a href=&quot;#RabbitMQ基本介绍&quot; class=&quot;headerlink&quot; title=&quot;RabbitMQ基本介绍&quot;&gt;&lt;/a&gt;RabbitMQ基本介绍&lt;/h3&gt;&lt;p&gt;RabbitMQ(Rabbit Message Queue)，即消息队列系统，它是一款开源消息队列中间件，采用Erlang语言开发，RabbitMQ是&lt;a href=&quot;https://spring.io/understanding/AMQP&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AMQP(Advanced Message Queueing Protocol)&lt;/a&gt;的标准实现。&lt;/p&gt;
&lt;p&gt;AMQP是一个公开发布的异步消息的规范，是提供统一消息服务的应用层标准&lt;strong&gt;高级消息队列协议&lt;/strong&gt;，为面向消息的中间件设计，消息中间件主要用于组件之间的解耦，消息的发送者无需知道消息使用者的存在，反之亦然。相对于&lt;a href=&quot;https://en.wikipedia.org/wiki/Java_Message_Service&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;JMS(Java Message Service)&lt;/a&gt;规范来说，JMS使用的是特定的APIs，而消息格式可自由定义，而AMQP对消息的格式和传输是有要求的，但实现不会受操作系统、开发语言以及平台等的限制。&lt;/p&gt;
&lt;p&gt;JMS和AMQP还有一个较大的区别：JMS有队列(Queues)和主题(Topics)两种形式，发送到JMS队列的消息最多只能被一个Client消费，发送到JMS主题的消息可能会被多个Clients消费；AMQP只有队列(Queues)，队列的消息只能被单个接受者消费，发送者并不直接把消息发送到队列中，而是发送到Exchange中，该Exchage会与一个或多个队列绑定，能够实现与JMS队列和主题同样的功能。&lt;/p&gt;
&lt;p&gt;RabbitMQ的主要宣传点在于其健壮性好、易于使用、高性能、高并发、集群易扩展以及强大的开源社区支持，鉴于些，在实际项目中使用还是比较可靠有价值的。接下来就介绍一下RabbitMQ从安装到简单示例的入门教程。&lt;/p&gt;
&lt;h3 id=&quot;RabbitMQ下载安装&quot;&gt;&lt;a href=&quot;#RabbitMQ下载安装&quot; class=&quot;headerlink&quot; title=&quot;RabbitMQ下载安装&quot;&gt;&lt;/a&gt;RabbitMQ下载安装&lt;/h3&gt;&lt;p&gt;这里提供三种方式下载并安装RabbitMQ Server：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;需要在&lt;a href=&quot;https://www.rabbitmq.com/download.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RabbitMQ下载页&lt;/a&gt;下载对应操作系统的RabbitMQ Server安装包进行安装。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;通过命令行安装，比如如果在MAC系统下可以通过homebrew安装。&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ brew install rabbitmq&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ rabbitmq-server       &lt;span class=&quot;comment&quot;&gt;# 解压并以默认设置启动&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;通过&lt;a href=&quot;https://docs.docker.com/compose/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Docker Compose&lt;/a&gt;快速启动RabbitMQ Server，但需要保证已经安装并启动了Docker服务，然后创建&lt;code&gt;docker-compose.yml&lt;/code&gt;的文件，并在同目录下执行命令&lt;code&gt;docker-compose up&lt;/code&gt;即可启动RabbitMQ服务。推荐使用该方式，方便快捷，并在独立Container中运行。&lt;/p&gt;
&lt;figure class=&quot;highlight yml&quot;&gt;&lt;figcaption&gt;&lt;span&gt;docker-compose.yml&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rabbitmq:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  image:&lt;/span&gt; rabbitmq:management&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;5672:5672&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;15672:15672&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在安装完成并启动服务后，可通过访问&lt;a href=&quot;http://localhost:15672&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:15672&lt;/a&gt;测试，默认用户名和密码是&lt;code&gt;guest&lt;/code&gt;。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/overview_totals.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;RabbitMQ入门使用&quot;&gt;&lt;a href=&quot;#RabbitMQ入门使用&quot; class=&quot;headerlink&quot; title=&quot;RabbitMQ入门使用&quot;&gt;&lt;/a&gt;RabbitMQ入门使用&lt;/h3&gt;&lt;p&gt;以Java为例集成RabbitMQ，针对不同应用场景使用其对应的功能，以下入门示例都出自&lt;a href=&quot;http://www.rabbitmq.com/getstarted.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;官网教程&lt;/a&gt;。&lt;/p&gt;
&lt;h5 id=&quot;应用场景一：Simple-Queue-“Hello-Word”&quot;&gt;&lt;a href=&quot;#应用场景一：Simple-Queue-“Hello-Word”&quot; class=&quot;headerlink&quot; title=&quot;应用场景一：Simple Queue “Hello Word”&quot;&gt;&lt;/a&gt;应用场景一：Simple Queue “Hello Word”&lt;/h5&gt;&lt;p&gt;一个&lt;strong&gt;P&lt;/strong&gt;roducer发送消息到Queue中，一个&lt;strong&gt;C&lt;/strong&gt;onsumer从Queue读取消息并打印。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/simple_queue.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;有兴趣可参阅示例代码：&lt;a href=&quot;https://github.com/Waterstrong/spring-rabbitmq/tree/master/src/main/java/ws/demo/rabbitmq/message/helloWorld&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hello World Demo&lt;/a&gt;。&lt;/p&gt;
&lt;h5 id=&quot;应用场景二：Work-Queues&quot;&gt;&lt;a href=&quot;#应用场景二：Work-Queues&quot; class=&quot;headerlink&quot; title=&quot;应用场景二：Work Queues&quot;&gt;&lt;/a&gt;应用场景二：Work Queues&lt;/h5&gt;&lt;p&gt;将消息分配给多个Consumer进行处理，可以避免在执行资源密集性任务时同步处理导致阻塞等待的问题，从而在一定程度上提升并行能力，通常称该类Consumer为Work，多个Work在后台接收分配到的任务并处理。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/work_queues.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h5 id=&quot;应用场景三：Publish-Subscribe&quot;&gt;&lt;a href=&quot;#应用场景三：Publish-Subscribe&quot; class=&quot;headerlink&quot; title=&quot;应用场景三：Publish/Subscribe&quot;&gt;&lt;/a&gt;应用场景三：Publish/Subscribe&lt;/h5&gt;&lt;p&gt;前两个场景都是把一个消息传递给一个Consumer/Worker，而这里的Publish/Subscribe需要把消息传递给多个Consumer。这里Producer不会将消息直接发送到队列，事实上，Producer也并不知道消息会传递给任何的Queue，而是将消息发送到一个Exchange上，Exchange的作用在于收到Producer的消息并推送给绑定的Queue，这样Exchange就将消息传递给绑定的Queues及其以对应的Consumer了，这里使用的Exchange是&lt;code&gt;fanout&lt;/code&gt;，其实就是广播功能。Exchange通常分为四种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;fanout：该类型路由规则非常简单，会把所有发送到该Exchange的消息路由到所有与它绑定的Queue中，相当于广播功能&lt;/li&gt;
&lt;li&gt;direct：该类型路由规则会将消息路由到binding key与routing key完全匹配的Queue中，在场景四中会用到&lt;/li&gt;
&lt;li&gt;topic：与direct类型相似，只是规则没有那么严格，可以模糊匹配和多条件匹配，在场景五中会进一步解释&lt;/li&gt;
&lt;li&gt;headers：该类型不依赖于routing key与binding key的匹配规则来路由消息，而是根据发送的消息内容中的headers属性进行匹配&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/assets/rabbitmq-guide/publish_subscribe.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;比如一个打印Log的系统，当所有接收Log的Consumer接收到消息后都可以打印Log，有兴趣可参阅示例代码：&lt;a href=&quot;https://github.com/Waterstrong/spring-rabbitmq/tree/master/src/main/java/ws/demo/rabbitmq/message/publishsubscribe&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Publish/Subscribe Demo&lt;/a&gt;。&lt;/p&gt;
&lt;h5 id=&quot;应用场景四：Routing&quot;&gt;&lt;a href=&quot;#应用场景四：Routing&quot; class=&quot;headerlink&quot; title=&quot;应用场景四：Routing&quot;&gt;&lt;/a&gt;应用场景四：Routing&lt;/h5&gt;&lt;p&gt;在上一场景中，只是一个简单的Log系统，相当于广播功能，更进一步，可以针对不同的日志发送到不同的Consumer进行不同的处理，比如有的写文件，有的打印控制台等，那么就需要定义Routing路由了。为了使用Routing功能，可以将Exchange定义为&lt;code&gt;direct&lt;/code&gt;类型，需要设置&lt;code&gt;routing_key&lt;/code&gt;绑定到Queue上，然后就可以发送消息了。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/routing.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h5 id=&quot;应用场景五：Topics&quot;&gt;&lt;a href=&quot;#应用场景五：Topics&quot; class=&quot;headerlink&quot; title=&quot;应用场景五：Topics&quot;&gt;&lt;/a&gt;应用场景五：Topics&lt;/h5&gt;&lt;p&gt;在以上场景中，使用&lt;code&gt;direct&lt;/code&gt;类型的Exchange可以实现对不同消息的路由，但只是支持单一的条件，为了支持多种条件，比如不仅针对Log的级别，还要针对其来源进行分发消息，这时候可以使用Topic来实现了，其中的逻辑和&lt;code&gt;direct&lt;/code&gt;的类似，只是&lt;code&gt;routing_key&lt;/code&gt;支持多个用点&lt;code&gt;.&lt;/code&gt;分隔的值用于匹配路由信息，其中路由Key可以使用&lt;code&gt;*&lt;/code&gt;替代一个词，&lt;code&gt;#&lt;/code&gt;匹配0个或多个词。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/topics.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;有兴趣可参阅示例代码：&lt;a href=&quot;https://github.com/Waterstrong/spring-rabbitmq/tree/master/src/main/java/ws/demo/rabbitmq/message/topics&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Topics Demo&lt;/a&gt;。&lt;/p&gt;
&lt;h5 id=&quot;应用场景六：RPC-Remote-procedure-call&quot;&gt;&lt;a href=&quot;#应用场景六：RPC-Remote-procedure-call&quot; class=&quot;headerlink&quot; title=&quot;应用场景六：RPC(Remote procedure call)&quot;&gt;&lt;/a&gt;应用场景六：RPC(Remote procedure call)&lt;/h5&gt;&lt;p&gt;在前面的场景二中，能够实现使用&lt;em&gt;Work Queues&lt;/em&gt;分发处理运算任务，但如果需要将任务发送到远程服务器上执行处理，然后等待返回运算结果呢？那就需要RPC远程过程回调了。这里描述的场景将和之前的完全不一样，需要构建一个Client和RPC Server，Client作为远程调用的发起者携带一些如&lt;code&gt;reply_to&lt;/code&gt;,&lt;code&gt;correlation_id&lt;/code&gt;等的特定信息发送请求到&lt;code&gt;rpc_queue&lt;/code&gt;上，RPC Server接收到请求后执行处理函数并将运算结果返回给&lt;code&gt;Callback Queue&lt;/code&gt;，Client就可以接收到对应&lt;code&gt;correlationId&lt;/code&gt;的返回结果了。&lt;br&gt;&lt;img src=&quot;/assets/rabbitmq-guide/rpc.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;The-End-结束语&quot;&gt;&lt;a href=&quot;#The-End-结束语&quot; class=&quot;headerlink&quot; title=&quot;The End 结束语&quot;&gt;&lt;/a&gt;The End 结束语&lt;/h3&gt;&lt;p&gt;本节只是针对RabbitMQ的主要功能及基本使用进行了介绍，如果对RabbitMQ的服务配置、客户端应用以及插件管理感兴趣，可以阅读下一篇博客&lt;a href=&quot;/rabbitmq-professional&quot;&gt;RabbitMQ进阶指南&lt;/a&gt;了解更多精彩内容。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.rabbitmq.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RabbitMQ Home&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.rabbitmq.com/getstarted.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RabbitMQ Tutorials&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://spring.io/understanding/AMQP&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Understanding AMQP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://spring.io/guides/gs/messaging-rabbitmq/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Messaging with RabbitMQ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      RabbitMQ是一款开源消息队列中间件，采用Erlang语言开发，RabbitMQ是AMQP的标准实现，在易用性、扩展性、高可用性等方面表现不错。
    
    </summary>
    
      <category term="Frameworks" scheme="http://blog.waterstrong.me/categories/Frameworks/"/>
    
    
      <category term="AMQP" scheme="http://blog.waterstrong.me/tags/AMQP/"/>
    
      <category term="RabbitMQ" scheme="http://blog.waterstrong.me/tags/RabbitMQ/"/>
    
      <category term="Message" scheme="http://blog.waterstrong.me/tags/Message/"/>
    
      <category term="Topic" scheme="http://blog.waterstrong.me/tags/Topic/"/>
    
      <category term="Exchange" scheme="http://blog.waterstrong.me/tags/Exchange/"/>
    
      <category term="Queue" scheme="http://blog.waterstrong.me/tags/Queue/"/>
    
  </entry>
  
  <entry>
    <title>JTA实现分布式事务</title>
    <link href="http://blog.waterstrong.me/xa-transactions-with-jta/"/>
    <id>http://blog.waterstrong.me/xa-transactions-with-jta/</id>
    <published>2016-10-18T14:05:32.000Z</published>
    <updated>2016-11-11T13:29:13.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;开门见山&quot;&gt;&lt;a href=&quot;#开门见山&quot; class=&quot;headerlink&quot; title=&quot;开门见山&quot;&gt;&lt;/a&gt;开门见山&lt;/h2&gt;&lt;p&gt;关于事务的基本概念和介绍请参阅另一篇博客&lt;a href=&quot;/transactional-mechanism-protocol&quot;&gt;事务处理机制与协议&lt;/a&gt;，这里着重讲解如何在Spring中基于JTA(Java Transaction API)实现分布式事务并实践。&lt;/p&gt;
&lt;p&gt;Spring Boot除了对非XA的事务进行了封装处理，并提供了注解@Transactional的方式实现事务管理，也对多XA资源的分布式JTA事务提供了很好的支持，通常可选的内嵌事务管理器有&lt;code&gt;Atomikos&lt;/code&gt;和&lt;code&gt;Bitronix&lt;/code&gt;，任意选择一个作为实现XA事务管理的管理器即可。&lt;/p&gt;
&lt;p&gt;接下来就分别介绍利用Spring Boot实现非XA和XA的事务处理。&lt;/p&gt;
&lt;h2 id=&quot;Spring对非XA事务的实现&quot;&gt;&lt;a href=&quot;#Spring对非XA事务的实现&quot; class=&quot;headerlink&quot; title=&quot;Spring对非XA事务的实现&quot;&gt;&lt;/a&gt;Spring对非XA事务的实现&lt;/h2&gt;&lt;p&gt;使用Spring Boot实现&lt;strong&gt;非XA事务&lt;/strong&gt;非常简单，只需要简单的两步即可：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在构建脚本文件中加入依赖&lt;code&gt;org.springframework.boot:spring-boot-starter-jdbc&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;无论采用基本的&lt;code&gt;JdbcTemplate&lt;/code&gt;或封装的&lt;code&gt;JPA&lt;/code&gt;与数据库进行交互，只需要在具体方法上加注解&lt;code&gt;@Transactional(org.springframework.transaction.annotation.Transactional)&lt;/code&gt;。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这样就将该块的操作序列当作一个事务单元进行管理，任何失败或异常都将导致所有操作序列回滚，一个具体的简单Demo可参见&lt;a href=&quot;https://github.com/Waterstrong/spring-bitronix/tree/master/src/main/java/ws/transaction/demo&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Transaction Demo&lt;/a&gt;，另外，如果注解加在类名上，则代表该类中每个方法都将作为一个事务单元被管理。&lt;/p&gt;
&lt;h2 id=&quot;采用Atomikos事务管理器&quot;&gt;&lt;a href=&quot;#采用Atomikos事务管理器&quot; class=&quot;headerlink&quot; title=&quot;采用Atomikos事务管理器&quot;&gt;&lt;/a&gt;采用Atomikos事务管理器&lt;/h2&gt;&lt;p&gt;Atomikos是一款JTA事务管理器的开源库，能够Embedded到Spring Boot中，可以通过添加依赖&lt;code&gt;spring-boot-starter-jta-atomikos&lt;/code&gt;，然后Spring Boot会自动配置Atomikos并下载其依赖库，默认的事务日志文件会被写在项目下的&lt;code&gt;transaction-logs&lt;/code&gt;文件目录下的日志文件中，可以通过配置&lt;code&gt;spring.jta.log-dir&lt;/code&gt;来指定日志目录。可以设置&lt;code&gt;spring.jta.atomikos.properties&lt;/code&gt;读取相应的配置文件。可以参阅完成的详细信息AtomikosProperties &lt;a href=&quot;http://docs.spring.io/spring-boot/docs/1.4.1.RELEASE/api/org/springframework/boot/jta/atomikos/AtomikosProperties.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Javadoc&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;为了保证多个事务管理器能够正常安全地协调相同的资源管理器，每一个Atomikos实例必须配置一个唯一的ID，默认值为当前所在机器IP，通常在产品环境中，可以为每个应用程序实例配置&lt;code&gt;spring.jta.transaction-manager-id&lt;/code&gt;为不同的值。&lt;/p&gt;
&lt;p&gt;在Spring Boot中，可以自定义在应用程序配置文件中配置&lt;a href=&quot;https://github.com/spring-projects/spring-boot/tree/v1.4.1.RELEASE/spring-boot/src/main/java/org/springframework/boot/jta/atomikos/AtomikosProperties.java&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AtomikosProperties&lt;/a&gt;参数：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.borrow-connection-timeout=30 &lt;span class=&quot;comment&quot;&gt;# Timeout, in seconds, for borrowing connections from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.ignore-session-transacted-flag=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not to ignore the transacted flag when creating session.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.local-transaction-mode=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not local transactions are desired.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.maintenance-interval=60 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, between runs of the pool&#39;s maintenance thread.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.max-idle-time=60 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, after which connections are cleaned up from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.max-lifetime=0 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, that a connection can be pooled for before being destroyed. 0 denotes no limit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.max-pool-size=1 &lt;span class=&quot;comment&quot;&gt;# The maximum size of the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.min-pool-size=1 &lt;span class=&quot;comment&quot;&gt;# The minimum size of the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.reap-timeout=0 &lt;span class=&quot;comment&quot;&gt;# The reap timeout, in seconds, for borrowed connections. 0 denotes no limit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.connectionfactory.unique-resource-name=jmsConnectionFactory &lt;span class=&quot;comment&quot;&gt;# The unique name used to identify the resource during recovery.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.borrow-connection-timeout=30 &lt;span class=&quot;comment&quot;&gt;# Timeout, in seconds, for borrowing connections from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.default-isolation-level= &lt;span class=&quot;comment&quot;&gt;# Default isolation level of connections provided by the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.login-timeout= &lt;span class=&quot;comment&quot;&gt;# Timeout, in seconds, for establishing a database connection.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.maintenance-interval=60 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, between runs of the pool&#39;s maintenance thread.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.max-idle-time=60 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, after which connections are cleaned up from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.max-lifetime=0 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, that a connection can be pooled for before being destroyed. 0 denotes no limit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.max-pool-size=1 &lt;span class=&quot;comment&quot;&gt;# The maximum size of the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.min-pool-size=1 &lt;span class=&quot;comment&quot;&gt;# The minimum size of the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.reap-timeout=0 &lt;span class=&quot;comment&quot;&gt;# The reap timeout, in seconds, for borrowed connections. 0 denotes no limit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.test-query= &lt;span class=&quot;comment&quot;&gt;# SQL query or statement used to validate a connection before returning it.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.datasource.unique-resource-name=dataSource &lt;span class=&quot;comment&quot;&gt;# The unique name used to identify the resource during recovery.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.checkpoint-interval=500 &lt;span class=&quot;comment&quot;&gt;# Interval between checkpoints.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.console-file-count=1 &lt;span class=&quot;comment&quot;&gt;# Number of debug logs files that can be created.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.console-file-limit=-1 &lt;span class=&quot;comment&quot;&gt;# How many bytes can be stored at most in debug logs files.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.console-file-name=tm.out &lt;span class=&quot;comment&quot;&gt;# Debug logs file name.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.console-log-level= &lt;span class=&quot;comment&quot;&gt;# Console log level.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.default-jta-timeout=10000 &lt;span class=&quot;comment&quot;&gt;# Default timeout for JTA transactions.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.enable-logging=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Enable disk logging.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.force-shutdown-on-vm-exit=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Specify if a VM shutdown should trigger forced shutdown of the transaction core.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.log-base-dir= &lt;span class=&quot;comment&quot;&gt;# Directory in which the log files should be stored.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.log-base-name=tmlog &lt;span class=&quot;comment&quot;&gt;# Transactions log file base name.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.max-actives=50 &lt;span class=&quot;comment&quot;&gt;# Maximum number of active transactions.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.max-timeout=300000 &lt;span class=&quot;comment&quot;&gt;# Maximum timeout (in milliseconds) that can be allowed for transactions.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.output-dir= &lt;span class=&quot;comment&quot;&gt;# Directory in which to store the debug log files.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.serial-jta-transactions=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Specify if sub-transactions should be joined when possible.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.service= &lt;span class=&quot;comment&quot;&gt;# Transaction manager implementation that should be started.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.threaded-two-phase-commit=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Use different (and concurrent) threads for two-phase commit on the participating resources.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.atomikos.properties.transaction-manager-unique-name= &lt;span class=&quot;comment&quot;&gt;# Transaction manager&#39;s unique name.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一个具体的Atomikos分布式事务管理示例可参见&lt;a href=&quot;https://github.com/Waterstrong/spring-atomikos&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Atomikos Demo&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;采用Bitronix事务管理器&quot;&gt;&lt;a href=&quot;#采用Bitronix事务管理器&quot; class=&quot;headerlink&quot; title=&quot;采用Bitronix事务管理器&quot;&gt;&lt;/a&gt;采用Bitronix事务管理器&lt;/h2&gt;&lt;p&gt;Bitronix是一款JTA事务管理器的开源库，可以通过添加依赖&lt;code&gt;spring-boot-starter-jta-bitronix&lt;/code&gt;，然后Spring Boot会自动配置Bitronix，默认的事务日志文件会被写在项目下的&lt;code&gt;transaction-logs&lt;/code&gt;文件目录下的&lt;code&gt;part1.btm&lt;/code&gt;和&lt;code&gt;part2.btm&lt;/code&gt;中，可以通过配置&lt;code&gt;spring.jta.log-dir&lt;/code&gt;来指定日志目录。可以设置&lt;code&gt;spring.jta.bitronix.properties&lt;/code&gt;读取相应的配置文件，相当于自定义配置&lt;code&gt;bitronix.tm.configuration&lt;/code&gt;实例。&lt;/p&gt;
&lt;p&gt;为了保证多个事务管理器能够正常安全地协调相同的资源管理器，每一个Bitronix实例必须配置一个唯一的ID，默认值为当前所在机器IP，通常在产品环境中，可以为每个应用程序实例配置&lt;code&gt;spring.jta.transaction-manager-id&lt;/code&gt;为不同的值。&lt;/p&gt;
&lt;p&gt;在Spring Boot集成应用中，可以根据自定义需求在应用程序配置文件中配置以下参数：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.acquire-increment=1 &lt;span class=&quot;comment&quot;&gt;# Number of connections to create when growing the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.acquisition-interval=1 &lt;span class=&quot;comment&quot;&gt;# Time, in seconds, to wait before trying to acquire a connection again after an invalid connection was acquired.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.acquisition-timeout=30 &lt;span class=&quot;comment&quot;&gt;# Timeout, in seconds, for acquiring connections from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.allow-local-transactions=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not the transaction manager should allow mixing XA and non-XA transactions.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.apply-transaction-timeout=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not the transaction timeout should be set on the XAResource when it is enlisted.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.automatic-enlisting-enabled=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not resources should be enlisted and delisted automatically.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.cache-producers-consumers=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not produces and consumers should be cached.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.defer-connection-release=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not the provider can run many transactions on the same connection and supports transaction interleaving.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.ignore-recovery-failures=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not recovery failures should be ignored.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.max-idle-time=60 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, after which connections are cleaned up from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.max-pool-size=10 &lt;span class=&quot;comment&quot;&gt;# The maximum size of the pool. 0 denotes no limit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.min-pool-size=0 &lt;span class=&quot;comment&quot;&gt;# The minimum size of the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.password= &lt;span class=&quot;comment&quot;&gt;# The password to use to connect to the JMS provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.share-transaction-connections=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#  Whether or not connections in the ACCESSIBLE state can be shared within the context of a transaction.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.test-connections=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not connections should be tested when acquired from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.two-pc-ordering-position=1 &lt;span class=&quot;comment&quot;&gt;# The position that this resource should take during two-phase commit (always first is Integer.MIN_VALUE, always last is Integer.MAX_VALUE).&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.unique-name=jmsConnectionFactory &lt;span class=&quot;comment&quot;&gt;# The unique name used to identify the resource during recovery.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.use-tm-join=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; Whether or not TMJOIN should be used when starting XAResources.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.connectionfactory.user= &lt;span class=&quot;comment&quot;&gt;# The user to use to connect to the JMS provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.acquire-increment=1 &lt;span class=&quot;comment&quot;&gt;# Number of connections to create when growing the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.acquisition-interval=1 &lt;span class=&quot;comment&quot;&gt;# Time, in seconds, to wait before trying to acquire a connection again after an invalid connection was acquired.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.acquisition-timeout=30 &lt;span class=&quot;comment&quot;&gt;# Timeout, in seconds, for acquiring connections from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.allow-local-transactions=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not the transaction manager should allow mixing XA and non-XA transactions.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.apply-transaction-timeout=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not the transaction timeout should be set on the XAResource when it is enlisted.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.automatic-enlisting-enabled=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not resources should be enlisted and delisted automatically.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.cursor-holdability= &lt;span class=&quot;comment&quot;&gt;# The default cursor holdability for connections.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.defer-connection-release=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not the database can run many transactions on the same connection and supports transaction interleaving.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.enable-jdbc4-connection-test= &lt;span class=&quot;comment&quot;&gt;# Whether or not Connection.isValid() is called when acquiring a connection from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.ignore-recovery-failures=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Whether or not recovery failures should be ignored.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.isolation-level= &lt;span class=&quot;comment&quot;&gt;# The default isolation level for connections.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.local-auto-commit= &lt;span class=&quot;comment&quot;&gt;# The default auto-commit mode for local transactions.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.login-timeout= &lt;span class=&quot;comment&quot;&gt;# Timeout, in seconds, for establishing a database connection.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.max-idle-time=60 &lt;span class=&quot;comment&quot;&gt;# The time, in seconds, after which connections are cleaned up from the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.max-pool-size=10 &lt;span class=&quot;comment&quot;&gt;# The maximum size of the pool. 0 denotes no limit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.min-pool-size=0 &lt;span class=&quot;comment&quot;&gt;# The minimum size of the pool.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.prepared-statement-cache-size=0 &lt;span class=&quot;comment&quot;&gt;# The target size of the prepared statement cache. 0 disables the cache.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.share-transaction-connections=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#  Whether or not connections in the ACCESSIBLE state can be shared within the context of a transaction.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.test-query= &lt;span class=&quot;comment&quot;&gt;# SQL query or statement used to validate a connection before returning it.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.two-pc-ordering-position=1 &lt;span class=&quot;comment&quot;&gt;# The position that this resource should take during two-phase commit (always first is Integer.MIN_VALUE, always last is Integer.MAX_VALUE).&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.unique-name=dataSource &lt;span class=&quot;comment&quot;&gt;# The unique name used to identify the resource during recovery.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.datasource.use-tm-join=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; Whether or not TMJOIN should be used when starting XAResources.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.allow-multiple-lrc=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Allow multiple LRC resources to be enlisted into the same transaction.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.asynchronous2-pc=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Enable asynchronously execution of two phase commit.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.background-recovery-interval-seconds=60 &lt;span class=&quot;comment&quot;&gt;# Interval in seconds at which to run the recovery process in the background.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.current-node-only-recovery=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Recover only the current node.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.debug-zero-resource-transaction=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Log the creation and commit call stacks of transactions executed without a single enlisted resource.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.default-transaction-timeout=60 &lt;span class=&quot;comment&quot;&gt;# Default transaction timeout in seconds.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.disable-jmx=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Enable JMX support.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.exception-analyzer= &lt;span class=&quot;comment&quot;&gt;# Set the fully qualified name of the exception analyzer implementation to use.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.filter-log-status=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Enable filtering of logs so that only mandatory logs are written.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.force-batching-enabled=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#  Set if disk forces are batched.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.forced-write-enabled=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Set if logs are forced to disk.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.graceful-shutdown-interval=60 &lt;span class=&quot;comment&quot;&gt;# Maximum amount of seconds the TM will wait for transactions to get done before aborting them at shutdown time.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.jndi-transaction-synchronization-registry-name= &lt;span class=&quot;comment&quot;&gt;# JNDI name of the TransactionSynchronizationRegistry.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.jndi-user-transaction-name= &lt;span class=&quot;comment&quot;&gt;# JNDI name of the UserTransaction.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.journal=disk &lt;span class=&quot;comment&quot;&gt;# Name of the journal. Can be &#39;disk&#39;, &#39;null&#39; or a class name.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.log-part1-filename=btm1.tlog &lt;span class=&quot;comment&quot;&gt;# Name of the first fragment of the journal.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.log-part2-filename=btm2.tlog &lt;span class=&quot;comment&quot;&gt;# Name of the second fragment of the journal.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.max-log-size-in-mb=2 &lt;span class=&quot;comment&quot;&gt;# Maximum size in megabytes of the journal fragments.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.resource-configuration-filename= &lt;span class=&quot;comment&quot;&gt;# ResourceLoader configuration file name.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.server-id= &lt;span class=&quot;comment&quot;&gt;# ASCII ID that must uniquely identify this TM instance. Default to the machine&#39;s IP address.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.skip-corrupted-logs=&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Skip corrupted transactions log entries.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spring.jta.bitronix.properties.warn-about-zero-resource-transaction=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# Log a warning for transactions executed without a single&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一个具体的Bitronix分布式事务管理示例可参见&lt;a href=&quot;https://github.com/Waterstrong/spring-bitronix/tree/master/src/main/java/ws/xa/bitronix/demo&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Bitronix Demo&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;混合XA-非XA事务的JMS连接&quot;&gt;&lt;a href=&quot;#混合XA-非XA事务的JMS连接&quot; class=&quot;headerlink&quot; title=&quot;混合XA/非XA事务的JMS连接&quot;&gt;&lt;/a&gt;混合XA/非XA事务的JMS连接&lt;/h2&gt;&lt;p&gt;当使用JTA时，默认情况下，主要的JMS&lt;code&gt;ConnectionFactory&lt;/code&gt;实例会被自动加入到XA资源中，并参与XA事务。如果在某些情况下，如JMS处理时间较长，超过了XA的Timeout时间，则需要在处理JMS时不使用XA的&lt;code&gt;ConnectionFactory&lt;/code&gt;，只需在注入时使用&lt;code&gt;nonXaJmsConnectionFactory&lt;/code&gt;即可，以下是代码示例：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Inject the primary (XA aware) ConnectionFactory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; ConnectionFactory defaultConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Inject the XA aware ConnectionFactory (uses the alias and injects the same as above)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Qualifier&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;xaJmsConnectionFactory&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; ConnectionFactory xaConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Inject the non-XA aware ConnectionFactory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Qualifier&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;nonXaJmsConnectionFactory&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; ConnectionFactory nonXaConnectionFactory;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;General-Databases&quot;&gt;&lt;a href=&quot;#General-Databases&quot; class=&quot;headerlink&quot; title=&quot;General Databases&quot;&gt;&lt;/a&gt;General Databases&lt;/h2&gt;&lt;p&gt;针对不同的数据库可能需要设置一些不同的参数开启XA功能，比如Postgresql，需要设置参数&lt;code&gt;max_prepared_transactions&lt;/code&gt;，整型值，它决定能够同时处于prepared状态的事务的最大数目，0表示关闭prepared事务的特性，该值通常应该和max_connections的值一样大。&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;figcaption&gt;&lt;span&gt;postgresql.conf&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;max_prepared_transactions&lt;/span&gt;=30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果使用AWS的Postgresql RDS数据库，则需要在Parameter Group中设置该值，否则默认会为0，表示关闭XA功能。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/transaction.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Transaction Management&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-jta.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Spring Distributed Transactions with JTA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.atomikos.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Atomikos Home&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.spring.io/spring-boot/docs/1.3.3.RELEASE/api/org/springframework/boot/jta/atomikos/AtomikosProperties.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Class AtomikosProperties&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/bitronix/btm&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Home of Bitronix JTA Transaction Manager&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/spring-projects/spring-boot/tree/v1.3.3.RELEASE/spring-boot/src/main/java/org/springframework/boot/jta&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Spring Boot JTA Code on GitHub&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://spring.io/guides/gs/managing-transactions/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Managing Transactions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html#commit_transactions&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Using Transactions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Common application properties&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      Spring Boot除了对非XA的事务进行了封装处理，并提供了注解@Transactional的方式实现事务管理，也对多XA资源的分布式JTA事务提供了很好的支持，通常可选的内嵌事务管理器有Atomikos和Bitronix。
    
    </summary>
    
      <category term="Techniques" scheme="http://blog.waterstrong.me/categories/Techniques/"/>
    
    
      <category term="分布式事务" scheme="http://blog.waterstrong.me/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
      <category term="Spring Boot" scheme="http://blog.waterstrong.me/tags/Spring-Boot/"/>
    
      <category term="Transaction" scheme="http://blog.waterstrong.me/tags/Transaction/"/>
    
      <category term="JTA" scheme="http://blog.waterstrong.me/tags/JTA/"/>
    
      <category term="Bitronix" scheme="http://blog.waterstrong.me/tags/Bitronix/"/>
    
      <category term="Atomikos" scheme="http://blog.waterstrong.me/tags/Atomikos/"/>
    
  </entry>
  
  <entry>
    <title>Groovy SQL Batch</title>
    <link href="http://blog.waterstrong.me/groovy-sql-batch/"/>
    <id>http://blog.waterstrong.me/groovy-sql-batch/</id>
    <published>2016-09-14T14:38:59.000Z</published>
    <updated>2017-02-16T16:30:37.000Z</updated>
    
    <content type="html">&lt;p&gt;通常，如果需要写一些针对数据库临时执行特定操作的脚本时，Groovy是一个不错的选择，如果数据量比较大的情况下需要用到Batch方式，接下来就我们就使用Groovy SQL快速实现一个简单的数据库批量操作Demo，如对已有User的姓名进行修饰更新。&lt;/p&gt;
&lt;h2 id=&quot;Preparation&quot;&gt;&lt;a href=&quot;#Preparation&quot; class=&quot;headerlink&quot; title=&quot;Preparation&quot;&gt;&lt;/a&gt;Preparation&lt;/h2&gt;&lt;p&gt;准备阶段主要Import依赖，以及配置数据库各项属性并创建连接：&lt;br&gt;&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; groovy.sql.Sql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.springframework.test.context.jdbc.Sql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# Also can set to &lt;span class=&quot;keyword&quot;&gt;project&lt;/span&gt;.ext.sql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; sql = Sql.newInstance(&lt;span class=&quot;string&quot;&gt;&#39;url&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;user&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;pwd&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;driver&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# Set the variables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ext &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    batchSize = &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    customizeFile = &lt;span class=&quot;keyword&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;file.txt&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Statement&quot;&gt;&lt;a href=&quot;#Statement&quot; class=&quot;headerlink&quot; title=&quot;Statement&quot;&gt;&lt;/a&gt;Statement&lt;/h2&gt;&lt;p&gt;创建语句并执行，比如写一个查询和更新：&lt;br&gt;&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; getUsers() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    println &lt;span class=&quot;string&quot;&gt;&#39;Start to find users...&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sql.rows &lt;span class=&quot;string&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        SELECT USER_ID AS userId, USER_NAME AS userName FROM TB_USER WITH UR&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &quot;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;String getUpdateStatement() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        UPDATE TB_USER SET USER_NAME=? WHERE USER_ID=?&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &quot;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Extraction&quot;&gt;&lt;a href=&quot;#Extraction&quot; class=&quot;headerlink&quot; title=&quot;Extraction&quot;&gt;&lt;/a&gt;Extraction&lt;/h2&gt;&lt;p&gt;Extration可以从查询结果中提取值并重新赋值给新对象，同时写入记录到文件中，建议采用&lt;code&gt;withWriter&lt;/code&gt;高效写文件的方式：&lt;br&gt;&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;List extractUserIds(users) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    println &lt;span class=&quot;string&quot;&gt;&#39;Start to extract users...&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; userIds = [:]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    customizeFile.withWriter &amp;#123; writer -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        users.each &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            userIds.put(it.userId, it.userNames)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            writer.println it.userId&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    userIds&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Transaction-amp-Batch&quot;&gt;&lt;a href=&quot;#Transaction-amp-Batch&quot; class=&quot;headerlink&quot; title=&quot;Transaction &amp;amp; Batch&quot;&gt;&lt;/a&gt;Transaction &amp;amp; Batch&lt;/h2&gt;&lt;p&gt;对于指执行，建议采用先准备好Sql脚本并加入到Batch中的方式，这样可以按批发送给数据库执行，提升效率，同时在最外层加上事务管理：&lt;br&gt;&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; processBatchUpdate(userIds) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    println &lt;span class=&quot;string&quot;&gt;&quot;Start to batch(size: $batchSize) update...&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sql.withTransaction &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sql.withBatch(batchSize, updateStatement) &amp;#123; statement -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            userIds.each &amp;#123; statement.addBatch decorate(it.userName), it.userId &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    println &lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;userIds.size()&amp;#125; users updated&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Default-Task&quot;&gt;&lt;a href=&quot;#Default-Task&quot; class=&quot;headerlink&quot; title=&quot;Default Task&quot;&gt;&lt;/a&gt;Default Task&lt;/h2&gt;&lt;p&gt;默认会被执行的任务，通常是入口，并且执行完毕可应关闭数据库Session：&lt;br&gt;&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;defaultTasks = [&lt;span class=&quot;string&quot;&gt;&#39;defaultMain&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# Generally dependsOn: initialiseDriver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;task&lt;/span&gt; defaultMain() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    onlyIf &amp;#123; !customizeFile.exitsts() &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;doLast&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; userIds = extractUserIds(users)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        processBatchUpdate userIds&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sql.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;更多关于&lt;code&gt;Groovy SQL&lt;/code&gt;的用法可以参考官网资料&lt;a href=&quot;http://docs.groovy-lang.org/latest/html/api/groovy/sql/Sql.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Groovy Class Sql&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.groovy-lang.org/latest/html/api/groovy/sql/Sql.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Groovy Class Sql&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.schibsted.pl/blog/groovy-sql-an-easy-way-to-database-scripting/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GROOVY SQL – AN EASY WAY TO DATABASE SCRIPTING&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      通常，如果需要写一些针对数据库临时执行特定操作的脚本时，Groovy是一个不错的选择，如果数据量比较大的情况下需要用到Batch方式，接下来将介绍使用Groovy SQL快速实现一个简单的数据库Batch操作Demo。
    
    </summary>
    
      <category term="Languages" scheme="http://blog.waterstrong.me/categories/Languages/"/>
    
    
      <category term="Groovy" scheme="http://blog.waterstrong.me/tags/Groovy/"/>
    
      <category term="SQL" scheme="http://blog.waterstrong.me/tags/SQL/"/>
    
      <category term="Batch" scheme="http://blog.waterstrong.me/tags/Batch/"/>
    
  </entry>
  
  <entry>
    <title>Mac如何读写NTFS磁盘</title>
    <link href="http://blog.waterstrong.me/mac-rw-ntfs/"/>
    <id>http://blog.waterstrong.me/mac-rw-ntfs/</id>
    <published>2016-09-11T13:10:13.000Z</published>
    <updated>2017-02-16T16:34:20.000Z</updated>
    
    <content type="html">&lt;p&gt;其实老早就遇到了Mac下写NTFS的问题，本来因为有两块移动硬盘，把其中一块500G的格式化成了Mac支持的格式，用于备份一些重要数据，而另一块1T之前已经存了不少数据，也懒得麻烦就一直放着没有管，但最近电脑数据太多，已经报警磁盘空间不足，不得不进行数据备份了，最早的硬盘已差不多满了，但又不想改磁盘格式，并且以后还可能在Win下拷贝数据，必须得想办法解决在Mac读写NTFS磁盘问题。&lt;/p&gt;
&lt;p&gt;可能也有很多同学遇到和我类似的问题，但不用担心，其实是有办法解决的，可能有些同学愿意购买Mac读写NTFS磁盘的工具，或者使用虚拟机作为媒介再Share给Mac，个人而言，不希望安装过多的软件，有洁癖，虚拟机的方式太慢太啰嗦，怕麻烦，所以只能寻求Mac内置原生方式，而这里就将介绍这种更为快捷、简单、干净的方式，只需要两步即可。&lt;br&gt;&lt;img src=&quot;/assets/mac-rw-ntfs/disk_utility.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;Step1-配置fstab&quot;&gt;&lt;a href=&quot;#Step1-配置fstab&quot; class=&quot;headerlink&quot; title=&quot;Step1 配置fstab&quot;&gt;&lt;/a&gt;Step1 配置fstab&lt;/h4&gt;&lt;p&gt;在终端输入如下命令编辑&lt;code&gt;fstab&lt;/code&gt;文件，并写入&lt;code&gt;LABEL&lt;/code&gt;以及其值，若文件不存在将新建该文件。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo vim /etc/fstab&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LABEL=Datum none ntfs rw,auto,nobrowse  &lt;span class=&quot;comment&quot;&gt;# 使用磁盘名方式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LABEL=68D036FA-EE09-4B80-AC93-01E54D51059A none ntfs rw,auto,nobrowse  &lt;span class=&quot;comment&quot;&gt;# 使用UUID方式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中，&lt;code&gt;rw&lt;/code&gt;表示读写方式，&lt;code&gt;nobrowse&lt;/code&gt;表示默认不在finder的边栏中显示，如果不加&lt;code&gt;nobrowse&lt;/code&gt;可能在挂载后还是只读模式。&lt;code&gt;Datum&lt;/code&gt;是硬盘名或分出来的磁盘名，如果有多个磁盘可以重复再写一行，当然也可以使用磁盘UUID，可在应用程序中打开&lt;code&gt;Disk Utility&lt;/code&gt;工具查看，或者使用命令行方式查看，比如查看Datum盘信息的命令为：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;diskutil info /Volumes/Datum&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;Step2-打开磁盘&quot;&gt;&lt;a href=&quot;#Step2-打开磁盘&quot; class=&quot;headerlink&quot; title=&quot;Step2 打开磁盘&quot;&gt;&lt;/a&gt;Step2 打开磁盘&lt;/h4&gt;&lt;p&gt;由于设置了默认不在Finder边栏显示，因此需要手动打开磁盘，确保磁盘已经挂载成功，可以通过&lt;code&gt;Disk Utility&lt;/code&gt;或在命令行挂载并查看。&lt;br&gt;&lt;img src=&quot;/assets/mac-rw-ntfs/drive_info.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;打开硬盘磁盘的方式有两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在Finder中使用快捷键&lt;code&gt;cmd+shift+g&lt;/code&gt;并输入&lt;code&gt;/Volumes/Datum&lt;/code&gt;后可进入该磁盘目录&lt;/li&gt;
&lt;li&gt;命令行中运行&lt;code&gt;open /Volumes/Datum&lt;/code&gt;后进入该磁盘目录&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/assets/mac-rw-ntfs/volumes_folder.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;此时，应该可以对磁盘进行读写操作了，为了下次更加的方便，也可以直接拖拽磁盘到Finder边栏的Favorites中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意：&lt;/strong&gt;道听途说该方式有导致磁盘损坏和数据丢失的风险，使用时可能需要留意一下，尽量保存一份副本，到时可不要来找我哦^_^。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      如何实现在Mac下读写NTFS磁盘，除了购买Mac读写NTFS磁盘的工具，或使用虚拟机作为媒介再Share给Mac的方式外，还可以使用更为快捷、简单、干净的Mac内置原生方式解决写NTFS硬盘的问题。
    
    </summary>
    
      <category term="Techniques" scheme="http://blog.waterstrong.me/categories/Techniques/"/>
    
    
      <category term="Mac" scheme="http://blog.waterstrong.me/tags/Mac/"/>
    
      <category term="NTFS" scheme="http://blog.waterstrong.me/tags/NTFS/"/>
    
      <category term="移动硬盘" scheme="http://blog.waterstrong.me/tags/%E7%A7%BB%E5%8A%A8%E7%A1%AC%E7%9B%98/"/>
    
  </entry>
  
  <entry>
    <title>在集成测试中使用Stubby4J</title>
    <link href="http://blog.waterstrong.me/using-stubby4j/"/>
    <id>http://blog.waterstrong.me/using-stubby4j/</id>
    <published>2016-09-05T14:29:26.000Z</published>
    <updated>2016-11-20T14:32:50.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;什么是stubby4j？&quot;&gt;&lt;a href=&quot;#什么是stubby4j？&quot; class=&quot;headerlink&quot; title=&quot;什么是stubby4j？&quot;&gt;&lt;/a&gt;什么是stubby4j？&lt;/h2&gt;&lt;p&gt;Stubby4J是基于Java编写的，该项目是由个人发起的开源项目，它是一款非常灵活可配置的基于HTTP(s)协议测试Web服务交互的工具，采用内嵌式的Jetty作为HTTP服务器，它的主要作用在于，可以在集成测试时，用来模拟第三方Web服务的API行为，比如，目前比较流行的RESTful架构风格的Web服务。&lt;/p&gt;
&lt;h2 id=&quot;为什么使用Stubby4J？&quot;&gt;&lt;a href=&quot;#为什么使用Stubby4J？&quot; class=&quot;headerlink&quot; title=&quot;为什么使用Stubby4J？&quot;&gt;&lt;/a&gt;为什么使用Stubby4J？&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;模拟HTTP请求，Stub第三方API的返回数据&lt;/li&gt;
&lt;li&gt;在写集成测试时，Mock第三方API更加便捷&lt;/li&gt;
&lt;li&gt;能够验证发送的所有参数并指定详细返回数据&lt;/li&gt;
&lt;li&gt;目前支持所有HTTP方法：GET, POST, PUT, PATCH, DELETE, HEAD等&lt;/li&gt;
&lt;li&gt;支持HTTP和HTTPS协议，同时可模拟返回的错误码&lt;/li&gt;
&lt;li&gt;在性能测试和稳定性测试时，支持定义延时返回&lt;/li&gt;
&lt;li&gt;使用相对简单，配置非常便捷，启动也很快速&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;如何使用Stubby4J？&quot;&gt;&lt;a href=&quot;#如何使用Stubby4J？&quot; class=&quot;headerlink&quot; title=&quot;如何使用Stubby4J？&quot;&gt;&lt;/a&gt;如何使用Stubby4J？&lt;/h2&gt;&lt;h4 id=&quot;命令行快速启动&quot;&gt;&lt;a href=&quot;#命令行快速启动&quot; class=&quot;headerlink&quot; title=&quot;命令行快速启动&quot;&gt;&lt;/a&gt;命令行快速启动&lt;/h4&gt;&lt;p&gt;首先需要&lt;a href=&quot;http://search.maven.org/remotecontent?filepath=by/stub/stubby4j/3.3.0/stubby4j-3.3.0.jar&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;下载JAR包&lt;/a&gt;，假设本地已经安装了Java，然后在本地创建一个名为&lt;code&gt;cfg.yml&lt;/code&gt;的文件：&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;figcaption&gt;&lt;span&gt;cfg.yml&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; /hello-world&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  response:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    status:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;200&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    headers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        Content-Type:&lt;/span&gt; application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    body:&lt;/span&gt; Hello World!&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行如下命令启动Stubby4J:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ java -jar stubby4j-3.3.0.jar &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; cfg.yml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Loaded: [GET] /hello-world&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Admin portal configured at http://localhost:8889&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Admin portal status enabled at http://localhost:8889/status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Stubs portal configured at http://localhost:8882&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Stubs portal configured with TLS at https://localhost:7443 using internal keystore&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Jetty successfully started&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后访问&lt;a href=&quot;http://localhost:8882/hello-world&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:8882/hello-world&lt;/a&gt;可以看到返回的&lt;code&gt;Hello World!&lt;/code&gt;字样。&lt;/p&gt;
&lt;p&gt;如果需要进入Admin Portal，可以访问&lt;a href=&quot;http://localhost:8889/status&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:8889/status&lt;/a&gt;查看Stub的数据。&lt;/p&gt;
&lt;p&gt;更多命令行使用方式：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;usage:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       java -jar stubby4j-x.x.xx.jar [&lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt; &amp;lt;arg&amp;gt;] [&lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; &amp;lt;arg&amp;gt;] [-da] [-ds]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       [-h] [-k &amp;lt;arg&amp;gt;] [&lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; &amp;lt;arg&amp;gt;] [-m] [-o] [-p &amp;lt;arg&amp;gt;] [&lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; &amp;lt;arg&amp;gt;] [-t&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;lt;arg&amp;gt;] [-v] [-w]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt;,--admin &amp;lt;arg&amp;gt;             Port &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; admin portal. Defaults to 8889.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt;,--data &amp;lt;arg&amp;gt;              Data file to pre-load endpoints. Valid YAML&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              1.1 expected.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -da,--disable_admin_portal   Does not start Admin portal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -ds,--disable_ssl            Does not &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; SSL connections&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -h,--help                    This &lt;span class=&quot;built_in&quot;&gt;help&lt;/span&gt; text.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -k,--keystore &amp;lt;arg&amp;gt;          Keystore file &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; custom TLS. By default TLS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              is enabled using internal keystore.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt;,--location &amp;lt;arg&amp;gt;          Hostname at &lt;span class=&quot;built_in&quot;&gt;which&lt;/span&gt; to &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; stubby.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -m,--mute                    Mute console output.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -o,--debug                   Dumps raw HTTP request to the console (&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              console is not muted!).&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -p,--password &amp;lt;arg&amp;gt;          Password &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; the provided keystore file.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt;,--stubs &amp;lt;arg&amp;gt;             Port &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; stub portal. Defaults to 8882.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -t,--tls &amp;lt;arg&amp;gt;               Port &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; TLS connection. Defaults to 7443.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -v,--version                 Prints out to console stubby version.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; -w,--watch                   Periodically scans &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; changes &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; last&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              modification date of the main YAML and&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              referenced external files (&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; any). The flag&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              can accept an optional arg value &lt;span class=&quot;built_in&quot;&gt;which&lt;/span&gt; is&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              the watch scan time &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; milliseconds. If&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              milliseconds is not provided, the watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              scans every 100ms. If last modification date&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              changed since the last scan period, the stub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              configuration is reloaded&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;集成测试中的具体应用&quot;&gt;&lt;a href=&quot;#集成测试中的具体应用&quot; class=&quot;headerlink&quot; title=&quot;集成测试中的具体应用&quot;&gt;&lt;/a&gt;集成测试中的具体应用&lt;/h4&gt;&lt;p&gt;首先在Gradle中配置依赖，在&lt;code&gt;build.gradle&lt;/code&gt;中加入其依赖，只会在集成测试时使用，所以只需要加入&lt;code&gt;testCompile&lt;/code&gt;即可：&lt;br&gt;&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;testCompile &lt;span class=&quot;string&quot;&gt;&#39;by.stub:stubby4j:3.3.0&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后需要在加载应用程序Context前启动Stubby4J，常用启动stubby4j的方法如下:&lt;br&gt;&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;startJetty(&quot;stubby4j.yml&quot;)  # localhost默认端口: Stubs(8882), Admin(8889) and SslStubs portals(7443) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;startJetty(8882, &quot;stubby4j.yml&quot;) # 可以指定Stubs端口，其它为默认值&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;startJetty(8882, 8889, &quot;stubby4j.yml&quot;) # 可以指定Stubs和Admin端口，其它为默认值&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在集成测试启动之前执行&lt;code&gt;startJetty&lt;/code&gt;，需要在其Base父类中加入以下代码：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; StubbyClient API_STUB = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; StubbyClient();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@BeforeClass&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;startUp&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	API_STUB.startJetty(&lt;span class=&quot;number&quot;&gt;8882&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ClassPathResource(&lt;span class=&quot;string&quot;&gt;&quot;api/stubby4j.yml&quot;&lt;/span&gt;).getFile().getAbsolutePath());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中&lt;code&gt;api/stubby4j.yml&lt;/code&gt;文件位于集成测试代码的&lt;code&gt;resources&lt;/code&gt;目录下。&lt;/p&gt;
&lt;p&gt;在集成测试运行完成后需要停止stubby4j服务&lt;code&gt;stopJetty&lt;/code&gt;：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@AfterClass&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;shutDown&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	API_STUB.stopJetty();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;具体示例可参阅GitHub Demo: &lt;a href=&quot;https://github.com/Waterstrong/service-stubmock/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;service-stubmock stubby4j&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&quot;基于YAML文件的示例&quot;&gt;&lt;a href=&quot;#基于YAML文件的示例&quot; class=&quot;headerlink&quot; title=&quot;基于YAML文件的示例&quot;&gt;&lt;/a&gt;基于YAML文件的示例&lt;/h4&gt;&lt;p&gt;&lt;strong&gt;示例一：模拟GET请求并返回Json格式Payload&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; ^/users/&lt;span class=&quot;number&quot;&gt;111&lt;/span&gt;$&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  response:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    status:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;200&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    headers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        content-type:&lt;/span&gt; application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    body:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&quot;userId&quot;: 111, &quot;userName&quot;: &quot;Peter&quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; /users/&lt;span class=&quot;number&quot;&gt;123&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  response:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    status:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;404&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中的&lt;code&gt;request:url&lt;/code&gt;支持正则表达式，比如&lt;code&gt;^/[a-z]{3}-[a-z]{3}/[0-9]{2}/[A-Z]{2}/[a-z0-9]+$&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;示例二：在request时指定多个methods&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; /anything&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; [GET, HEAD]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; /anything&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; HEAD&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;示例三：可以指定查询参数&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; ^/with/parameters$&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    query:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        search:&lt;/span&gt; search terms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        filter:&lt;/span&gt; month&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中&lt;code&gt;query&lt;/code&gt;中的元素会匹配&lt;code&gt;url&lt;/code&gt;后的查询参数&lt;code&gt;?key1=value1&amp;amp;key2=value2&lt;/code&gt;，并且任意顺序都可以被匹配到，以下两组URL都会被匹配到：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/with/parameters?search=search+terms&amp;amp;filter=month&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/with/parameters?filter=month&amp;amp;search=search+terms&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果查询参数只有KEY没有VALUE，则匹配时URL需要给定KEY，Payload如下：&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; ^/with/parameters$&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    query:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        search:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        filter:&lt;/span&gt; month&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;则以下两组URL都会被匹配到：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/with/parameters?search&amp;amp;filter=month&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/with/parameters?search=&amp;amp;filter=month&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;示例四：POST时指定发送的Payload&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; ^/path/to/something$&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; POST&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    headers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        Content-Type:&lt;/span&gt; application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        authorization-basic:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;bob:password&quot;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        x-custom-header:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;^this/is/\d/test&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    post:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&quot;key&quot;: value, &quot;data&quot;: &quot;content&quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;span class=&quot;attr&quot;&gt;  response:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    headers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        Content-Type:&lt;/span&gt; application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    status:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;201&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    body:&lt;/span&gt; Your request was successfully processed!&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;示例五：返回的Response是Json文件&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- request:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    method:&lt;/span&gt; GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    url:&lt;/span&gt; /users/&lt;span class=&quot;number&quot;&gt;456&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  response:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    status:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;200&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    headers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        Content-Type:&lt;/span&gt; application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    file:&lt;/span&gt; json/users-response.json&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中的file路径是当前YAML文件的相对路径。&lt;/p&gt;
&lt;p&gt;Request和Response的Payload除了使用JSON外，还可以使用XML格式或直接使用文本，另外配置文件除了使用YAML格式外，也可以合适JSON格式。更多示例可以参考&lt;a href=&quot;https://github.com/azagniotov/stubby4j&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;github stubby4j&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/azagniotov/stubby4j&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;github stubby4j&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      Stubby4J一款灵活可配置的基于HTTP(s)协议测试Web服务交互的工具，采用内嵌式的Jetty作为HTTP服务器，它的主要作用在于，可以在集成测试时，用来模拟第三方Web服务的API行为，比如，目前比较流行的RESTful架构风格的Web服务。
    
    </summary>
    
      <category term="Tools" scheme="http://blog.waterstrong.me/categories/Tools/"/>
    
    
      <category term="Stub" scheme="http://blog.waterstrong.me/tags/Stub/"/>
    
      <category term="Mock" scheme="http://blog.waterstrong.me/tags/Mock/"/>
    
      <category term="HTTP" scheme="http://blog.waterstrong.me/tags/HTTP/"/>
    
      <category term="集成测试" scheme="http://blog.waterstrong.me/tags/%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>快速掌握和使用Flyway</title>
    <link href="http://blog.waterstrong.me/flyway-in-practice/"/>
    <id>http://blog.waterstrong.me/flyway-in-practice/</id>
    <published>2016-08-31T13:32:16.000Z</published>
    <updated>2016-10-16T15:52:39.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;什么是Flyway&quot;&gt;&lt;a href=&quot;#什么是Flyway&quot; class=&quot;headerlink&quot; title=&quot;什么是Flyway?&quot;&gt;&lt;/a&gt;什么是Flyway?&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Flyway is an open-source database migration tool. It strongly favors simplicity and convention over configuration.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Flyway是一款开源的数据库版本管理工具，它更倾向于规约优于配置的方式。Flyway可以独立于应用实现管理并跟踪数据库变更，支持数据库版本自动升级，并且有一套默认的规约，不需要复杂的配置，Migrations可以写成SQL脚本，也可以写在Java代码中，不仅支持Command Line和Java API，还支持Build构建工具和Spring Boot等，同时在分布式环境下能够安全可靠地升级数据库，同时也支持失败恢复等。&lt;/p&gt;
&lt;p&gt;Flyway主要基于6种基本命令：&lt;code&gt;Migrate&lt;/code&gt;, &lt;code&gt;Clean&lt;/code&gt;, &lt;code&gt;Info&lt;/code&gt;, &lt;code&gt;Validate&lt;/code&gt;, &lt;code&gt;Baseline&lt;/code&gt; and &lt;code&gt;Repair&lt;/code&gt;，稍候会逐一分析讲解。目前支持的数据库主要有：Oracle, SQL Server, SQL Azure, DB2, DB2 z/OS, MySQL(including Amazon RDS), MariaDB, Google Cloud SQL, PostgreSQL(including Amazon RDS and Heroku), Redshift, Vertica, H2, Hsql, Derby, SQLite, SAP HANA, solidDB, Sybase ASE and Phoenix.&lt;/p&gt;
&lt;p&gt;关于Flyway的优势，支持的数据库以及与其他数据库版本工具的对比，可以阅读&lt;a href=&quot;https://flywaydb.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Flyway官网介绍&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;为什么使用Flyway&quot;&gt;&lt;a href=&quot;#为什么使用Flyway&quot; class=&quot;headerlink&quot; title=&quot;为什么使用Flyway?&quot;&gt;&lt;/a&gt;为什么使用Flyway?&lt;/h2&gt;&lt;p&gt;通常在项目开始时会针对数据库进行全局设计，但在开发产品新特性过程中，难免会遇到需要更新数据库Schema的情况，比如：添加新表，添加新字段和约束等，这种情况在实际项目中也经常发生。那么，当开发人员完成了对数据库更的SQL脚本后，如何快速地在其他开发者机器上同步？并且如何在测试服务器上快速同步？以及如何保证集成测试能够顺利执行并通过呢？&lt;/p&gt;
&lt;p&gt;假设以Spring Boot技术栈项目为例，可能有人会说，本地使用Hibernate自动更新数据库Schema模式，然后让QA或DEV到测试服务器上手动执行SQL脚本，同时可以写一个Gradle任务自动执行更新。&lt;/p&gt;
&lt;p&gt;个人觉得，对于Hibernate自动更新数据库，感觉不靠谱，不透明，控制自由度不高，而且有时很容易就会犯错，比如：用SQL创建的某个字段为VARCHAR类型，而在Entity中配置的为CHAR类型，那么在运行集成测试时，自动创建的数据库表中的字段为CHAR类型，而实际SQL脚本期望的是VARCHAR类型，虽然测试通过了，但不是期望的行为，并且在本地bootRun或服务器上运行Service时都会失败。另外，到各测试服务器上手动执行SQL脚本费时费神费力的，干嘛不自动化呢，当然，对于高级别和PROD环境，还是需要DBA手动执行的。最后，写一段自动化程序来自动执行更新，想法是很好的，那如果已经有了一些插件或库可以帮助你更好地实现这样的功能，为何不好好利用一下呢，当然，如果是为了学习目的，重复造轮子是无可厚非的。&lt;/p&gt;
&lt;p&gt;其实，以上问题可以通过Flyway工具来解决，Flyway可以实现自动化的数据库版本管理，并且能够记录数据库版本更新记录，Flyway官网对&lt;a href=&quot;https://flywaydb.org/getstarted/why&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Why database migrations&lt;/a&gt;结合示例进行了详细的阐述，有兴趣可以参阅一下。&lt;/p&gt;
&lt;h2 id=&quot;Flyway如何工作的&quot;&gt;&lt;a href=&quot;#Flyway如何工作的&quot; class=&quot;headerlink&quot; title=&quot;Flyway如何工作的?&quot;&gt;&lt;/a&gt;Flyway如何工作的?&lt;/h2&gt;&lt;p&gt;Flyway对数据库进行版本管理主要由Metadata表和6种命令完成，Metadata主要用于记录元数据，每种命令功能和解决的问题范围不一样，以下分别对metadata表和这些命令进行阐述，其中的示意图都来自Flyway的官方文档。&lt;/p&gt;
&lt;h4 id=&quot;Metadata-Table&quot;&gt;&lt;a href=&quot;#Metadata-Table&quot; class=&quot;headerlink&quot; title=&quot;Metadata Table&quot;&gt;&lt;/a&gt;Metadata Table&lt;/h4&gt;&lt;p&gt;Flyway中最核心的就是用于记录所有版本演化和状态的Metadata表，在Flyway首次启动时会创建默认名为&lt;code&gt;SCHEMA_VERSION&lt;/code&gt;的元数据表，其表结构为(以MySQL为例)：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Field&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Type&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Null&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Key&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Default&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;version_rank&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;int(11)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;MUL&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;installed_rank&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;int(11)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;MUL&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;version&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;varchar(50)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;PRI&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;description&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;varchar(200)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;type&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;varchar(20)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;script&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;varchar(1000)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;checksum&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;int(11)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;YES&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;installed_by&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;varchar(100)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;installed_on&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;timestamp&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;CURRENT_TIMESTAMP&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;execution_time&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;int(11)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;success&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;tinyint(1)&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NO&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;MUL&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;NULL&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Flyway官网上提供了一个很清晰的示例&lt;a href=&quot;https://flywaydb.org/getstarted/how&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;How Flyway works&lt;/a&gt;，可以参阅一下。&lt;/p&gt;
&lt;h4 id=&quot;Migrate&quot;&gt;&lt;a href=&quot;#Migrate&quot; class=&quot;headerlink&quot; title=&quot;Migrate&quot;&gt;&lt;/a&gt;Migrate&lt;/h4&gt;&lt;p&gt;Migrate是指把数据库Schema迁移到最新版本，是Flyway工作流的核心功能，Flyway在Migrate时会检查Metadata(元数据)表，如果不存在会创建Metadata表，Metadata表主要用于记录版本变更历史以及Checksum之类的。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/command_migrate.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Migrate时会扫描指定文件系统或Classpath下的Migrations(可以理解为数据库的版本脚本)，并且会逐一比对Metadata表中的已存在的版本记录，如果有未应用的Migrations，Flyway会获取这些Migrations并按次序Apply到数据库中，否则不需要做任何事情。另外，通常在应用程序启动时应默认执行Migrate操作，从而避免程序和数据库的不一致性。&lt;/p&gt;
&lt;h4 id=&quot;Clean&quot;&gt;&lt;a href=&quot;#Clean&quot; class=&quot;headerlink&quot; title=&quot;Clean&quot;&gt;&lt;/a&gt;Clean&lt;/h4&gt;&lt;p&gt;Clean相对比较容易理解，即清除掉对应数据库Schema中的所有对象，包括表结构，视图，存储过程，函数以及所有的数据等都会被清除。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/command_clean.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Clean操作在开发和测试阶段是非常有用的，它能够帮助快速有效地更新和重新生成数据库表结构，但特别注意的是：不应在Production的数据库上使用！&lt;/p&gt;
&lt;h4 id=&quot;Info&quot;&gt;&lt;a href=&quot;#Info&quot; class=&quot;headerlink&quot; title=&quot;Info&quot;&gt;&lt;/a&gt;Info&lt;/h4&gt;&lt;p&gt;Info用于打印所有Migrations的详细和状态信息，其实也是通过Metadata表和Migrations完成的，下图很好地示意了Info打印出来的信息。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/command_info.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Info能够帮助快速定位当前的数据库版本，以及查看执行成功和失败的Migrations。&lt;/p&gt;
&lt;h4 id=&quot;Validate&quot;&gt;&lt;a href=&quot;#Validate&quot; class=&quot;headerlink&quot; title=&quot;Validate&quot;&gt;&lt;/a&gt;Validate&lt;/h4&gt;&lt;p&gt;Validate是指验证已经Apply的Migrations是否有变更，Flyway是默认是开启验证的。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/command_validate.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Validate原理是对比Metadata表与本地Migrations的Checksum值，如果值相同则验证通过，否则验证失败，从而可以防止对已经Apply到数据库的本地Migrations的无意修改。&lt;/p&gt;
&lt;h4 id=&quot;Baseline&quot;&gt;&lt;a href=&quot;#Baseline&quot; class=&quot;headerlink&quot; title=&quot;Baseline&quot;&gt;&lt;/a&gt;Baseline&lt;/h4&gt;&lt;p&gt;Baseline针对已经存在Schema结构的数据库的一种解决方案，即实现在非空数据库中新建Metadata表，并把Migrations应用到该数据库。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/command_baseline.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Baseline可以应用到特定的版本，这样在已有表结构的数据库中也可以实现添加Metadata表，从而利用Flyway进行新Migrations的管理了。&lt;/p&gt;
&lt;h4 id=&quot;Repair&quot;&gt;&lt;a href=&quot;#Repair&quot; class=&quot;headerlink&quot; title=&quot;Repair&quot;&gt;&lt;/a&gt;Repair&lt;/h4&gt;&lt;p&gt;Repair操作能够修复Metadata表，该操作在Metadata表出现错误时是非常有用的。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/command_repair.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Repair会修复Metadata表的错误，通常有两种用途：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;移除失败的Migration记录，该问题只是针对不支持DDL事务的数据库。&lt;/li&gt;
&lt;li&gt;重新调整已经应用的Migratons的Checksums值，比如：某个Migratinon已经被应用，但本地进行了修改，又期望重新应用并调整Checksum值，不过尽量不要这样操作，否则可能造成其它环境失败。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;如何使用Flyway&quot;&gt;&lt;a href=&quot;#如何使用Flyway&quot; class=&quot;headerlink&quot; title=&quot;如何使用Flyway?&quot;&gt;&lt;/a&gt;如何使用Flyway?&lt;/h2&gt;&lt;p&gt;这里将主要关注在Gradle和Spring Boot中集成并使用Flyway，数据库通常会采用MySQL、PostgreSQL、H2或Hsql等。&lt;/p&gt;
&lt;h4 id=&quot;正确创建Migrations&quot;&gt;&lt;a href=&quot;#正确创建Migrations&quot; class=&quot;headerlink&quot; title=&quot;正确创建Migrations&quot;&gt;&lt;/a&gt;正确创建Migrations&lt;/h4&gt;&lt;p&gt;&lt;strong&gt;Migrations&lt;/strong&gt;是指Flyway在更新数据库时是使用的版本脚本，比如：一个基于Sql的Migration命名为&lt;code&gt;V1__init_tables.sql&lt;/code&gt;，内容即是创建所有表的sql语句，另外，Flyway也支持基于Java的Migration。Flyway加载Migrations的默认Locations为&lt;code&gt;classpath:db/migration&lt;/code&gt;，也可以指定&lt;code&gt;filesystem:/project/folder&lt;/code&gt;，其加载是在Runtime自动递归地执行的。&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/sql_migration_base_dir.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;除了需要指定Location外，Flyway对Migrations的扫描还必须遵从一定的命名模式，Migration主要分为两类：Versioned和Repeatable。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Versioned migrations&lt;/strong&gt;&lt;br&gt;一般常用的是Versioned类型，用于版本升级，每一个版本都有一个唯一的标识并且只能被应用一次，并且不能再修改已经加载过的Migrations，因为Metadata表会记录其Checksum值。其中的version标识版本号，由一个或多个数字构成，数字之间的分隔符可以采用点或下划线，在运行时下划线其实也是被替换成点了，每一部分的前导零会被自动忽略。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Repeatable migrations&lt;/strong&gt;&lt;br&gt;Repeatable是指可重复加载的Migrations，其每一次的更新会影响Checksum值，然后都会被重新加载，并不用于版本升级。对于管理不稳定的数据库对象的更新时非常有用。Repeatable的Migrations总是在Versioned之后按顺序执行，但开发者必须自己维护脚本并且确保可以重复执行，通常会在sql语句中使用&lt;code&gt;CREATE OR REPLACE&lt;/code&gt;来保证可重复执行。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;默认情况下基于Sql的Migration文件的命令规则如下图所示：&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/sql_migration_naming.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;其中的文件名由以下部分组成，除了使用默认配置外，某些部分还可自定义规则。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;prefix: 可配置，前缀标识，默认值&lt;code&gt;V&lt;/code&gt;表示Versioned，&lt;code&gt;R&lt;/code&gt;表示Repeatable&lt;/li&gt;
&lt;li&gt;version: 标识版本号，由一个或多个数字构成，数字之间的分隔符可用点&lt;code&gt;.&lt;/code&gt;或下划线&lt;code&gt;_&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;separator: 可配置，用于分隔版本标识与描述信息，默认为两个下划线&lt;code&gt;__&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;description: 描述信息，文字之间可以用下划线或空格分隔&lt;/li&gt;
&lt;li&gt;suffix: 可配置，后续标识，默认为&lt;code&gt;.sql&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外，关于如何使用基于Java的Migrations，有兴趣可以参考&lt;a href=&quot;https://flywaydb.org/documentation/migration/java&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java-based migrations&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&quot;支持的数据库&quot;&gt;&lt;a href=&quot;#支持的数据库&quot; class=&quot;headerlink&quot; title=&quot;支持的数据库&quot;&gt;&lt;/a&gt;支持的数据库&lt;/h4&gt;&lt;p&gt;目前Flyway支持的数据库还是挺多的，包括：Oracle, SQL Server, SQL Azure, DB2, DB2 z/OS, MySQL(including Amazon RDS), MariaDB, Google Cloud SQL, PostgreSQL(including Amazon RDS and Heroku), Redshift, Vertica, H2, Hsql, Derby, SQLite, SAP HANA, solidDB, Sybase ASE and Phoenix。&lt;br&gt;目前来说，个人用得比较多的数据库是&lt;a href=&quot;https://flywaydb.org/documentation/database/postgresql&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;PostgreSQL&lt;/a&gt;、&lt;a href=&quot;https://flywaydb.org/documentation/database/mysql&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MySQL&lt;/a&gt;、&lt;a href=&quot;https://flywaydb.org/documentation/database/h2&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;H2&lt;/a&gt;和&lt;a href=&quot;https://flywaydb.org/documentation/database/hsql&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hsql&lt;/a&gt;，针对每种数据库的&lt;code&gt;flyway.url&lt;/code&gt;示例配置为：&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# PostgreSQL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.url = jdbc:postgresql://localhost:5432/postgres?currentSchema=myschema&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# MySQL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.url = jdbc:mysql://localhost:3306/testdb?serverTimezone=UTC&amp;amp;useSSL=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# H2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.url = jdbc:h2:./.tmp/testdb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Hsql&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.url = jdbc:hsqldb:hsql//localhost:1476/testdb&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;Flyway命令行&quot;&gt;&lt;a href=&quot;#Flyway命令行&quot; class=&quot;headerlink&quot; title=&quot;Flyway命令行&quot;&gt;&lt;/a&gt;Flyway命令行&lt;/h4&gt;&lt;p&gt;Flyway的命令行工具支持直接在命令行中运行&lt;code&gt;Migrate&lt;/code&gt;, &lt;code&gt;Clean&lt;/code&gt;, &lt;code&gt;Info&lt;/code&gt;, &lt;code&gt;Validate&lt;/code&gt;, &lt;code&gt;Baseline&lt;/code&gt;和&lt;code&gt;Repair&lt;/code&gt;6种命令，不需要借助其他Build工具，不需要应用程序运行在JVM中，只需要单纯的命令行即可，但需要根据不同的操作系统&lt;a href=&quot;https://flywaydb.org/documentation/commandline/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;下载&lt;/a&gt;并安装该命令行工具。Flyway会依次搜索以下配置文件，越靠后的配置会覆盖靠前的配置：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;install-dir&gt;/conf/flyway.conf&lt;/install-dir&gt;&lt;/li&gt;
&lt;li&gt;&lt;user-home&gt;/flyway.conf&lt;/user-home&gt;&lt;/li&gt;
&lt;li&gt;&lt;current-dir&gt;/flyway.conf&lt;/current-dir&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一个典型Flyway项目示例目录结构如下：&lt;br&gt;&lt;img src=&quot;/assets/flyway-in-practice/cli_directory_structure.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;更多关于Flyway命令行使用可以参考&lt;a href=&quot;https://flywaydb.org/documentation/commandline/migrate&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Flyway Command-line&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&quot;在Gradle中的应用&quot;&gt;&lt;a href=&quot;#在Gradle中的应用&quot; class=&quot;headerlink&quot; title=&quot;在Gradle中的应用&quot;&gt;&lt;/a&gt;在Gradle中的应用&lt;/h4&gt;&lt;p&gt;首先需要在Gradle中引入Flyway插件，通常有两种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;方式一：采用buildscript依赖方式。&lt;/p&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;buildscript&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;repositories&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        mavenCentral()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;dependencies&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;classpath&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;org.flywaydb:flyway-gradle-plugin:4.0.3&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apply plugin: &lt;span class=&quot;string&quot;&gt;&#39;org.flywaydb.flyway&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;方式二（推荐）：采用DSL方式引用Plugins。&lt;/p&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;plugins &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    id &lt;span class=&quot;string&quot;&gt;&quot;org.flywaydb.flyway&quot;&lt;/span&gt; version &lt;span class=&quot;string&quot;&gt;&quot;4.0.3&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;而在Gradle中配置Flyway Properties有两种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;方式一：在&lt;code&gt;build.gradle&lt;/code&gt;中配置Flyway Properties。&lt;/p&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;flyway &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	url = jdbc:h2:.&lt;span class=&quot;regexp&quot;&gt;/.tmp/&lt;/span&gt;testdb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	user = sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	password = &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 或者写成：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;project&lt;/span&gt;.ext[&lt;span class=&quot;string&quot;&gt;&#39;flyway.url&#39;&lt;/span&gt;] = &lt;span class=&quot;string&quot;&gt;&#39;jdbc:h2:./.tmp/testdb&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;project&lt;/span&gt;.ext[&lt;span class=&quot;string&quot;&gt;&#39;flyway.user&#39;&lt;/span&gt;] = &lt;span class=&quot;string&quot;&gt;&#39;sa&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;project&lt;/span&gt;.ext[&lt;span class=&quot;string&quot;&gt;&#39;flyway.password&#39;&lt;/span&gt;] = &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;方式二：在&lt;code&gt;gradle.properties&lt;/code&gt;中配置Flyway Properties。&lt;/p&gt;
&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.url = jdbc:h2:./.tmp/testdb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.user = sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.password =&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果期望在运行Gradle Clean/Build Tasks时自动执行Flyway的某些任务，可以设置&lt;code&gt;dependsOn&lt;/code&gt;，若不期望隐式执行Flyway任务，可以不配置。&lt;br&gt;&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;clean.dependsOn flywayRepair  # To repair the Flyway metadata table&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;build.dependsOn flywayMigrate  # To migrate the schema to the latest version&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;另外，其它Tasks：&lt;code&gt;flywayInfo&lt;/code&gt;, &lt;code&gt;flywayValidate&lt;/code&gt;, &lt;code&gt;flywayBaseline&lt;/code&gt;分别对应到Flyway的命令。在使用Spring Boot时，运行&lt;code&gt;./gradlew bootRun&lt;/code&gt;会自动检查并加载最新的db.migration脚本。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;特别注意：&lt;/strong&gt;在Production环境中不应执行&lt;code&gt;./gradlew flywayClean&lt;/code&gt;，除非你知道自己的行为和目的，因为该命令会清除所有的数据库对象，相当危险。&lt;/p&gt;
&lt;p&gt;更多关于Flyway在Gradle中的使用请参阅&lt;a href=&quot;https://flywaydb.org/documentation/gradle/migrate&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Flyway Gradle Plugin&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&quot;与Spring-Boot集成&quot;&gt;&lt;a href=&quot;#与Spring-Boot集成&quot; class=&quot;headerlink&quot; title=&quot;与Spring Boot集成&quot;&gt;&lt;/a&gt;与Spring Boot集成&lt;/h4&gt;&lt;p&gt;在Spring Boot中，如果加入Flyway的依赖，则会&lt;u&gt;自动引用Flyway并使用默认值&lt;/u&gt;，但可以修改并配置&lt;a href=&quot;https://github.com/spring-projects/spring-boot/tree/v1.4.0.RELEASE/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/flyway/FlywayProperties.java&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;FlywayProperties&lt;/a&gt;。&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.baseline-description= # The description to tag an existing schema with when executing baseline.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.baseline-version=1 # Version to start migration.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.baseline-&lt;span class=&quot;literal&quot;&gt;on&lt;/span&gt;-migrate=false # Whether to execute migration against a non-empty schema with no metadata table&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.check-location=false # Check that migration scripts location exists.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.clean-&lt;span class=&quot;literal&quot;&gt;on&lt;/span&gt;-validation-error=false # will clean &lt;span class=&quot;literal&quot;&gt;all&lt;/span&gt; objects. Warning! Do NOT enable in production!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.enabled=true # Enable flyway.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.encoding=UTF-8 # The encoding of migrations.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.ignore-failed-future-migration=true # Ignore future migrations when reading the metadata table.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.init-sqls= # SQL statements to execute to initialize a connection immediately after obtaining it.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.locations=classpath:db/migration # locations of migrations scripts.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.out-of-order=false # Allows migrations to be run &lt;span class=&quot;string&quot;&gt;&quot;out of order&quot;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.placeholder-prefix=  # The prefix of every placeholder.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.placeholder-replacement=true # Whether placeholders should be replaced.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.placeholder-suffix=&amp;#125; # The suffix of every placeholder.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.placeholders.*= # Placeholders to replace in Sql migrations.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.schemas= # Default schema of the connection and updating&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.sql-migration-prefix=V # The file name prefix for Sql migrations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.sql-migration-separator=__ # The file name separator for Sql migrations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.sql-migration-suffix=.sql # The file name suffix for Sql migrations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.table=schema_version # The name of Flyway&#39;s metadata table.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.url= # JDBC url of the database to migrate. If not set, the primary configured data source is used.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.user= # Login user of the database to migrate. If not set, use spring.datasource.username value.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.password= # JDBC password if you want Flyway to create its own DataSource.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;flyway&lt;/span&gt;.validate-&lt;span class=&quot;literal&quot;&gt;on&lt;/span&gt;-migrate=true # Validate sql migration CRC32 checksum in classpath.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;若使用Gradle，通常在&lt;code&gt;build.gradle&lt;/code&gt;引入&lt;code&gt;org.flywaydb:flyway-core:4.0.3&lt;/code&gt;依赖后即可使用。可能会有以下几种需求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;在本地Run和Tests都会使用内存数据库，其中的&lt;code&gt;spring.jpa.hibernate.ddl-auto&lt;/code&gt;都设置为&lt;code&gt;validate&lt;/code&gt;，Schema不需要Hibernate自动生成，并期望使用Flyway，而在线上环境会使用真实数据库，并不期望使用Flyway，如何实现呢？&lt;br&gt;&lt;strong&gt;解决方案：&lt;/strong&gt;可以在&lt;code&gt;common.properties&lt;/code&gt;中配置&lt;code&gt;flyway.enabled=false&lt;/code&gt;，然后在local或dev的配置中启用Flyway即可。通常推荐使用此模式，毕竟可以对不同的环境进行控制，另外本地Run不会依赖真实数据库，又能保证数据库Schema是按脚本创建的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在运行Tests会使用内存数据库，有单独的配置文件，不使用Flyway，而在本地bootRun时会使用真实数据库，使用Flyway，毕竟不想每次Schema改后都在本地手动去执行脚本，如何实现？&lt;br&gt;&lt;strong&gt;解决方案：&lt;/strong&gt;设置&lt;code&gt;bootRun.dependsOn&lt;/code&gt;动态添加Flyway的依赖即可：&lt;/p&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;addFlywayDenpendency &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;doLast&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;dependencies&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;compile&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&#39;org.flywaydb:flyway-core:4.0.3&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bootRun.dependsOn=addFlywayDenpendency&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;若项目有多个团队同时开发不同的功能，需要新建多个分支，并且都会涉及到数据库Schema更改，当后期Merge时，Migration的版本如何控制并且不会产生数据库更改的冲突呢？&lt;br&gt;&lt;strong&gt;解决方案：&lt;/strong&gt;如果两个分支的数据库更改有冲突，要么最初数据库设计不合理，要么目前数据库更改不合理，所以需要团队进行全局考虑和协调。而针对数据库在同一段时间有修改，但不会造成冲突的情况，通常实际项目中主要存在这样的情况，那可以设置&lt;code&gt;flyway.out-of-order=true&lt;/code&gt;，这样允许当v1和v3已经被应用后，v2出现时同样也可以被应用。其实在本地使用内存数据库不会存在该问题，因为数据库所有对象会自动清除掉，而在local或dev中使用真实数据库时可遇到这样的问题，因此需要注意一下了。&lt;br&gt;另外，值得一提的是Flyway的参数&lt;code&gt;ignore-failed-future-migration&lt;/code&gt;默认为&lt;code&gt;true&lt;/code&gt;，使用情形为：当Rollback数据库更改到旧版本，而metadata表中已存在了新版本时，Flyway会忽略此错误，只会显示警告信息。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;结束语&quot;&gt;&lt;a href=&quot;#结束语&quot; class=&quot;headerlink&quot; title=&quot;结束语&quot;&gt;&lt;/a&gt;结束语&lt;/h2&gt;&lt;p&gt;总得来说，Flyway可以有效改善数据库版本管理方式，如果项目中还未使用，不防尝试一下。如果有兴趣，也可以关注&lt;a href=&quot;http://mybatis.github.io/migrations/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MyBatis Migration&lt;/a&gt;，功能支持没有Flyway多，属于更轻量级的数据库版本管理工具。如果在使用过程中遇到了问题或坑，欢迎留言一起交流讨论。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://flywaydb.org/documentation/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Flyway Documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://flywaydb.org/documentation/gradle/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Gradle Plugin: Flyway&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Spring Common application properties&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-execute-flyway-database-migrations-on-startup&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Execute Flyway database migrations on startup&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      Flyway是一款开源的数据库版本管理工具，它更倾向于规约优于配置的方式。Flyway可以独立于应用实现管理并跟踪数据库变更，支持数据库版本自动升级，并且有一套默认的规约，不需要复杂的配置，不仅支持命令行和Java API，还支持Build构建工具和Spring Boot等，同时在分布式环境下能够安全可靠地升级数据库。
    
    </summary>
    
      <category term="Tools" scheme="http://blog.waterstrong.me/categories/Tools/"/>
    
    
      <category term="数据库" scheme="http://blog.waterstrong.me/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="Spring Boot" scheme="http://blog.waterstrong.me/tags/Spring-Boot/"/>
    
      <category term="Gradle" scheme="http://blog.waterstrong.me/tags/Gradle/"/>
    
      <category term="Flyway" scheme="http://blog.waterstrong.me/tags/Flyway/"/>
    
      <category term="Migration" scheme="http://blog.waterstrong.me/tags/Migration/"/>
    
  </entry>
  
  <entry>
    <title>代码质量管理SonarQube</title>
    <link href="http://blog.waterstrong.me/sonarqube-by-step/"/>
    <id>http://blog.waterstrong.me/sonarqube-by-step/</id>
    <published>2016-08-20T14:23:48.000Z</published>
    <updated>2016-10-16T15:55:29.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;&lt;p&gt;SonarQube是一个开源的代码质量管理平台，它能够快速分析并定位代码中明显或潜在错误信息，目前支持&lt;a href=&quot;http://docs.sonarqube.org/display/PLUG/Plugin+Library&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;20+种语言&lt;/a&gt;，并且有很多&lt;a href=&quot;http://docs.sonarqube.org/display/PLUG/SonarSource+Plugins&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;插件Plugins&lt;/a&gt;可以集成。接下来将大致讲解SonarQube的安装、配置及使用。&lt;/p&gt;
&lt;h2 id=&quot;Installation&quot;&gt;&lt;a href=&quot;#Installation&quot; class=&quot;headerlink&quot; title=&quot;Installation&quot;&gt;&lt;/a&gt;Installation&lt;/h2&gt;&lt;p&gt;以下所有操作均在CentOS下进行，其他系统的过程基本类似，只需要替换成对应命令即可，假设CentOS分配的IP地址为&lt;code&gt;192.168.56.105&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;Install-the-SonarQube&quot;&gt;&lt;a href=&quot;#Install-the-SonarQube&quot; class=&quot;headerlink&quot; title=&quot;Install the SonarQube&quot;&gt;&lt;/a&gt;Install the SonarQube&lt;/h4&gt;&lt;p&gt;首先到&lt;a href=&quot;http://www.sonarqube.org/downloads/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SonarQube Download&lt;/a&gt;页面下载压缩包，然后解压到&lt;code&gt;~/sonarqube&lt;/code&gt;文件夹，最后运行命令启动服务，需要Java8运行环境支持。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ~/sonarqube/bin/linux-x86-64/sonar.sh start  &lt;span class=&quot;comment&quot;&gt;# 启动SonarQube服务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Usage: ./sonar.sh &amp;#123; console | start | stop | restart | status | dump &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后访问&lt;a href=&quot;http://192.168.56.105:9000&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://192.168.56.105:9000&lt;/a&gt;将能够看到SonarQube页面，这里需要替换成你的IP地址，SonarQube会默认监听9000端口。&lt;br&gt;&lt;img src=&quot;/assets/sonarqube-by-step/sonarqube_home.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;其中，默认的管理员登录用户名和密码为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Login: &lt;code&gt;admin&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Password: &lt;code&gt;admin&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;虽然可以访问了，但当前SonarQube使用的是Embedded数据库，只能用于评估目的，不支持扩展和升级，更不支持数据迁移，因此强烈建议安装一款数据库引擎，不过别着急，稍候会涉及到配置PostgreSQL的操作过程。&lt;/p&gt;
&lt;h4 id=&quot;Install-the-Scanner&quot;&gt;&lt;a href=&quot;#Install-the-Scanner&quot; class=&quot;headerlink&quot; title=&quot;Install the Scanner&quot;&gt;&lt;/a&gt;Install the Scanner&lt;/h4&gt;&lt;p&gt;为了实现扫描项目代码并上传到SonarQube Server的目的，需要再到&lt;a href=&quot;http://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SonarQube Scanner Download&lt;/a&gt;页面下载压缩包并解压，如解压到&lt;code&gt;~/sonar-scanner&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ~/sonar-scanner/bin/sonar-scanner --version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: Scanner configuration file: ~/sonar-scanner/conf/sonar-scanner.properties&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: Project root configuration file: NONE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: SonarQube Scanner 2.6.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: Java 1.8.0_66 Oracle Corporation (64-bit)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: Linux 3.10.0-327.18.2.el7.x86_64 amd64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Configuration&quot;&gt;&lt;a href=&quot;#Configuration&quot; class=&quot;headerlink&quot; title=&quot;Configuration&quot;&gt;&lt;/a&gt;Configuration&lt;/h2&gt;&lt;p&gt;为了使用SonarQube的更多功能，支持扩展、升级和数据迁移，需要配置SonarQube，若安装目录为&lt;code&gt;~/sonarqube&lt;/code&gt;，则需要在安装目录中的&lt;code&gt;conf/sonar.properties&lt;/code&gt;中配置一些参数，主要针对数据库引擎配置和WEB访问地址和端口配置。&lt;/p&gt;
&lt;h4 id=&quot;Database&quot;&gt;&lt;a href=&quot;#Database&quot; class=&quot;headerlink&quot; title=&quot;Database&quot;&gt;&lt;/a&gt;Database&lt;/h4&gt;&lt;p&gt;以配置PostgresSQL为例，首先需要确保安装了PostgresSQL数据库引擎。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Database Configuration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sonar.jdbc.username=postgres  &lt;span class=&quot;comment&quot;&gt;# 好的方式是单独创建一个用户，并且授予读写库权限&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sonar.jdbc.password=postgres  &lt;span class=&quot;comment&quot;&gt;# 若postgresql设置trust本机，则无需提供密码，md5时需提供密码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# PostgreSQL URL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube  &lt;span class=&quot;comment&quot;&gt;# 需要先创建sonarqube数据库&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# MySQL JDBC URL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;amp;characterEncoding=utf8&amp;amp;rewriteBatchedStatements=true&amp;amp;useConfigs=maxPerformance&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在命令行中登录postgresql，创建命为&lt;code&gt;sonarqube&lt;/code&gt;的数据库，这里为了方便，直接使用postgres用户。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ psql -U postgres&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ CREATE DATABASE sonarqube WITH OWNER postgres ENCODING &lt;span class=&quot;string&quot;&gt;&#39;UTF8&#39;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;假设遇到了postgresql的登录问题，需要以root权限在&lt;code&gt;/var/lib/pgsql/data/pg_hba.conf&lt;/code&gt;中修改&lt;code&gt;localhost&lt;/code&gt;和&lt;code&gt;127.0.0.1&lt;/code&gt;的&lt;code&gt;peer&lt;/code&gt;为&lt;code&gt;trust&lt;/code&gt;或&lt;code&gt;md5&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#TYPE DATABASE  USER    ADDRESS        METHOD&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;local&lt;/span&gt;    &lt;span class=&quot;literal&quot;&gt;all&lt;/span&gt;    &lt;span class=&quot;literal&quot;&gt;all&lt;/span&gt;                    trust&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;host&lt;/span&gt;     &lt;span class=&quot;literal&quot;&gt;all&lt;/span&gt;    &lt;span class=&quot;literal&quot;&gt;all&lt;/span&gt;    127.0.0.1/32    trust&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;更多其他数据库配置可以参阅&lt;a href=&quot;http://docs.sonarqube.org/display/SONAR/Installing+the+Server&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Installing the Server&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&quot;Web&quot;&gt;&lt;a href=&quot;#Web&quot; class=&quot;headerlink&quot; title=&quot;Web&quot;&gt;&lt;/a&gt;Web&lt;/h4&gt;&lt;p&gt;可以修改&lt;code&gt;sonar.properties&lt;/code&gt;中的Web相关配置控制访问地址和端口。&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# The default port is &quot;9000&quot; and the context path is &quot;/&quot;. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# These values can be changed in sonar.properties.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.web.host=0.0.0.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.web.port=80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.web.context=/sonarqube&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;若以&lt;code&gt;80&lt;/code&gt;端口启动，可能会遇到权限的错误，需要切换为root用户运行sonar启动命令，可在&lt;code&gt;~/sonarqube/logs/sonar.log&lt;/code&gt;中查看日志。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Failed to initialize end point associated with ProtocolHandler [&lt;span class=&quot;string&quot;&gt;&quot;http-nio-0.0.0.0-80&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java.net.SocketException: Permission denied&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;配置完成后重启SonarQube服务，再访问&lt;a href=&quot;http://192.168.56.105/sonarqube&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://192.168.56.105/sonarqube&lt;/a&gt;，并且页面底端的红色警告消失了。&lt;br&gt;&lt;img src=&quot;/assets/sonarqube-by-step/sonarqube_home_new.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Analyzing-with-Scanner&quot;&gt;&lt;a href=&quot;#Analyzing-with-Scanner&quot; class=&quot;headerlink&quot; title=&quot;Analyzing with Scanner&quot;&gt;&lt;/a&gt;Analyzing with Scanner&lt;/h2&gt;&lt;h4 id=&quot;Runner&quot;&gt;&lt;a href=&quot;#Runner&quot; class=&quot;headerlink&quot; title=&quot;Runner&quot;&gt;&lt;/a&gt;Runner&lt;/h4&gt;&lt;p&gt;通常可以直接运行Runner实现对支持语言的项目代码进行扫描。假设Sonar Scanner被解压到&lt;code&gt;~/sonar-scanner&lt;/code&gt;文件夹中，随意找一个项目代码，并在其中添加&lt;code&gt;sonar-project.properties&lt;/code&gt;配置文件，针对Java项目的配置如下：&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Default SonarQube server&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# sonar.host.url=http://localhost:9000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.host.url=http://192.168.56.105/sonarqube&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Must be unique in a given SonarQube instance&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.projectKey=twee:qas-service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# This is the name displayed in the SonarQube UI&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.projectName=QAS Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.projectVersion=1.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Comma-separated paths to directories with sources&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Since SonarQube 4.2, this property is optional if sonar.modules is set. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# If not set, SonarQube starts looking for source code from the directory containing &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# the sonar-project.properties file.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.sources=src&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Language&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.language=java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Encoding of the source code. Default is default system encoding&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.sourceEncoding=UTF-8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果暂时自己没有适合的代码，也可以使用官方提供的&lt;a href=&quot;https://github.com/SonarSource/sonar-examples/archive/master.zip&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Project Samples&lt;/a&gt;，然后在项目代码目录下运行如下命令进行Sonar Scanner扫描代码。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;~/sonar-scanner/bin/sonar-scanner  &lt;span class=&quot;comment&quot;&gt;# 当然也可以直接把bin目录加入环境变量中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行后sonarqube runner后，界面上显示一条最新的Item记录：&lt;br&gt;&lt;img src=&quot;/assets/sonarqube-by-step/runner_scan_item.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;更多配置和用法可以参阅&lt;a href=&quot;http://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Analyzing with SonarQube Scanner&lt;/a&gt;。&lt;/p&gt;
&lt;h4 id=&quot;Gradle&quot;&gt;&lt;a href=&quot;#Gradle&quot; class=&quot;headerlink&quot; title=&quot;Gradle&quot;&gt;&lt;/a&gt;Gradle&lt;/h4&gt;&lt;p&gt;SonarQube支持Gradle 2.0以上的版本，以下来将配置&lt;code&gt;build.gradle&lt;/code&gt;文件，使得支持SonarQube任务。&lt;br&gt;&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Uses DSL plugins resolution introduced in Gradle 2.1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;plugins &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  id &lt;span class=&quot;string&quot;&gt;&quot;org.sonarqube&quot;&lt;/span&gt; version &lt;span class=&quot;string&quot;&gt;&quot;2.0.1&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sonarqube &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    properties &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        property &lt;span class=&quot;string&quot;&gt;&quot;sonar.projectName&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;QAS Service&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        property &lt;span class=&quot;string&quot;&gt;&quot;sonar.projectKey&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;tw.wee:qas-service&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        property &lt;span class=&quot;string&quot;&gt;&quot;sonar.projectVersion&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;v1.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        property &lt;span class=&quot;string&quot;&gt;&quot;sonar.jacoco.reportPath&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;project.buildDir&amp;#125;/jacoco/test.exec&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;还需要在&lt;code&gt;gradle.properties&lt;/code&gt;中配置SonarQube地址和登录信息：&lt;br&gt;&lt;figure class=&quot;highlight apacheconf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;systemProp&lt;/span&gt;.sonar.host.url=http://192.168.56.105/sonarqube&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 当sonar.forceAuthentication被设置成true时需要提供登录信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.login=admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;sonar&lt;/span&gt;.password=admin&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Gradle的Task为：&lt;code&gt;./gradlew sonarqube&lt;/code&gt;，并且可以指定HOST和PASSWORD，这样就避免了把密码明文写在配置文件中。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;./gradlew sonarqube -Dsonar.host.url=http://xxx/sonar -Dsonar.jdbc.password=*** -Dsonar.verbose=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行sonarqube tasks后，刷新界面，又多了一条新记录：&lt;br&gt;&lt;img src=&quot;/assets/sonarqube-by-step/gradle_scan_item.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;点击进入查看详细扫描结果：&lt;br&gt;&lt;img src=&quot;/assets/sonarqube-by-step/scanner_results.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;更多关于Gradle的配置可以参阅&lt;a href=&quot;http://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Gradle&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Analyzing with SonarQube Scanner for Gradle&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;SonarQube扫描还可以与Jenkins集成，有兴趣可以参阅&lt;a href=&quot;http://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Jenkins&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Analyzing with SonarQube Scanner for Jenkins&lt;/a&gt;实现步骤。&lt;/p&gt;
&lt;p&gt;除此之外，还可以对SonarQube的Dashboard进行配置，针对项目选择并添加一些需要关注和分析的Widget。&lt;br&gt;&lt;img src=&quot;/assets/sonarqube-by-step/widget_dashboard.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.sonarqube.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SonarQube官网&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.percona.com/blog/2007/11/01/innodb-performance-optimization-basics/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Innodb Performance Optimization Basics&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      SonarQube是一个开源的代码质量管理平台，它能够快速分析并定位代码中明显或潜在错误信息，目前支持20+种语言的分析，并且有很多插件可以集成。
    
    </summary>
    
      <category term="Platforms" scheme="http://blog.waterstrong.me/categories/Platforms/"/>
    
    
      <category term="Code Quality" scheme="http://blog.waterstrong.me/tags/Code-Quality/"/>
    
      <category term="Sonar Qube" scheme="http://blog.waterstrong.me/tags/Sonar-Qube/"/>
    
  </entry>
  
</feed>
