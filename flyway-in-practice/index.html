
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
    <meta name="generator" content="Waterstrong Blog">
    <title>快速掌握和使用Flyway - Waterstrong Blog</title>
    <meta name="author" content="Waterstrong">
    
        <meta name="keywords" content="Waterstrong,Shuiqiang,ThoughtWorks,">
    
    
        <link rel="icon" href="http://blog.waterstrong.me/assets/images/favicon.png">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Flyway是一款开源的数据库版本管理工具，它更倾向于规约优于配置的方式。Flyway可以独立于应用实现管理并跟踪数据库变更，支持数据库版本自动升级，并且有一套默认的规约，不需要复杂的配置，不仅支持命令行和Java API，还支持Build构建工具和Spring Boot等，同时在分布式环境下能够安全可靠地升级数据库。">
<meta property="og:type" content="blog">
<meta property="og:title" content="快速掌握和使用Flyway">
<meta property="og:url" content="http://blog.waterstrong.me/flyway-in-practice/index.html">
<meta property="og:site_name" content="Waterstrong Blog">
<meta property="og:description" content="Flyway是一款开源的数据库版本管理工具，它更倾向于规约优于配置的方式。Flyway可以独立于应用实现管理并跟踪数据库变更，支持数据库版本自动升级，并且有一套默认的规约，不需要复杂的配置，不仅支持命令行和Java API，还支持Build构建工具和Spring Boot等，同时在分布式环境下能够安全可靠地升级数据库。">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_migrate.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_clean.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_info.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_validate.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_baseline.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_repair.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/sql_migration_base_dir.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/sql_migration_naming.png">
<meta property="og:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/cli_directory_structure.png">
<meta property="og:updated_time" content="2016-10-16T15:52:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="快速掌握和使用Flyway">
<meta name="twitter:description" content="Flyway是一款开源的数据库版本管理工具，它更倾向于规约优于配置的方式。Flyway可以独立于应用实现管理并跟踪数据库变更，支持数据库版本自动升级，并且有一套默认的规约，不需要复杂的配置，不仅支持命令行和Java API，还支持Build构建工具和Spring Boot等，同时在分布式环境下能够安全可靠地升级数据库。">
<meta name="twitter:image" content="http://blog.waterstrong.me/assets/flyway-in-practice/command_migrate.png">
<meta name="twitter:creator" content="@shuiqianglin">
    
    
        
    
    
        <meta property="og:image" content="http://blog.waterstrong.me/assets/images/head.jpg"/>
    
    
        <meta property="og:image" content="http://blog.waterstrong.me/flyway-in-practice/assets/flyway-in-practice/flyway-logo-tm.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://blog.waterstrong.me/flyway-in-practice/assets/flyway-in-practice/flyway-logo-tm.png" />
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-uaqqjtjtrvw4f5t5rhgdurh1lvh2882tl8tgxjhprjiyx66slc64ghrlem3m.min.css">
    <!--STYLES END-->
    
    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?0eebfc18021c9d6853ca20f45d03d4a1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="6">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Waterstrong Blog</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/head.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="6">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about" title="Waterstrong">
                    <img class="sidebar-profile-picture" src="/assets/images/head.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Waterstrong</h4>
                
                    <h5 class="sidebar-profile-bio"><p>I’m Waterstrong! The man who has made up his mind to win will never say “Impossible” !<br> Stay quiet, run wild !<br> <a href="/about">More about…</a></p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-globe" title="Reload"></i>
                        <span class="sidebar-button-desc">Reload</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark" title="Categories"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" title="Tags"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-search" title="Search"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/about"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" title="About"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
                </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="http://waterstrong.me"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" title="Home"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/waterstrong"
                            
                                target="_blank"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github" title="GitHub"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/assets/images/qrcode.jpg"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-wechat" title="Wechat"></i>
                        <span class="sidebar-button-desc">Wechat</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="mailto:sqlin@thoughtworks.com"
                            
                                target="_blank"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o" title="Mail"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
                </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-rss" title="RSS"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
                </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/blogroll"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-link" title="Friends"></i>
                        <span class="sidebar-button-desc">Friends</span>
                    </a>
                </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="6"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            快速掌握和使用Flyway
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" datetime="2016-08-31T21:32:16+08:00">
	
		    Aug 31, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Tools/">Tools</a>


    
</div>

</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h2 id="什么是Flyway"><a href="#什么是Flyway" class="headerlink" title="什么是Flyway?"></a>什么是Flyway?</h2><blockquote>
<p>Flyway is an open-source database migration tool. It strongly favors simplicity and convention over configuration.</p>
</blockquote>
<p>Flyway是一款开源的数据库版本管理工具，它更倾向于规约优于配置的方式。Flyway可以独立于应用实现管理并跟踪数据库变更，支持数据库版本自动升级，并且有一套默认的规约，不需要复杂的配置，Migrations可以写成SQL脚本，也可以写在Java代码中，不仅支持Command Line和Java API，还支持Build构建工具和Spring Boot等，同时在分布式环境下能够安全可靠地升级数据库，同时也支持失败恢复等。</p>
<p>Flyway主要基于6种基本命令：<code>Migrate</code>, <code>Clean</code>, <code>Info</code>, <code>Validate</code>, <code>Baseline</code> and <code>Repair</code>，稍候会逐一分析讲解。目前支持的数据库主要有：Oracle, SQL Server, SQL Azure, DB2, DB2 z/OS, MySQL(including Amazon RDS), MariaDB, Google Cloud SQL, PostgreSQL(including Amazon RDS and Heroku), Redshift, Vertica, H2, Hsql, Derby, SQLite, SAP HANA, solidDB, Sybase ASE and Phoenix.</p>
<p>关于Flyway的优势，支持的数据库以及与其他数据库版本工具的对比，可以阅读<a href="https://flywaydb.org/" target="_blank" rel="external">Flyway官网介绍</a>。</p>
<h2 id="为什么使用Flyway"><a href="#为什么使用Flyway" class="headerlink" title="为什么使用Flyway?"></a>为什么使用Flyway?</h2><p>通常在项目开始时会针对数据库进行全局设计，但在开发产品新特性过程中，难免会遇到需要更新数据库Schema的情况，比如：添加新表，添加新字段和约束等，这种情况在实际项目中也经常发生。那么，当开发人员完成了对数据库更的SQL脚本后，如何快速地在其他开发者机器上同步？并且如何在测试服务器上快速同步？以及如何保证集成测试能够顺利执行并通过呢？</p>
<p>假设以Spring Boot技术栈项目为例，可能有人会说，本地使用Hibernate自动更新数据库Schema模式，然后让QA或DEV到测试服务器上手动执行SQL脚本，同时可以写一个Gradle任务自动执行更新。</p>
<p>个人觉得，对于Hibernate自动更新数据库，感觉不靠谱，不透明，控制自由度不高，而且有时很容易就会犯错，比如：用SQL创建的某个字段为VARCHAR类型，而在Entity中配置的为CHAR类型，那么在运行集成测试时，自动创建的数据库表中的字段为CHAR类型，而实际SQL脚本期望的是VARCHAR类型，虽然测试通过了，但不是期望的行为，并且在本地bootRun或服务器上运行Service时都会失败。另外，到各测试服务器上手动执行SQL脚本费时费神费力的，干嘛不自动化呢，当然，对于高级别和PROD环境，还是需要DBA手动执行的。最后，写一段自动化程序来自动执行更新，想法是很好的，那如果已经有了一些插件或库可以帮助你更好地实现这样的功能，为何不好好利用一下呢，当然，如果是为了学习目的，重复造轮子是无可厚非的。</p>
<p>其实，以上问题可以通过Flyway工具来解决，Flyway可以实现自动化的数据库版本管理，并且能够记录数据库版本更新记录，Flyway官网对<a href="https://flywaydb.org/getstarted/why" target="_blank" rel="external">Why database migrations</a>结合示例进行了详细的阐述，有兴趣可以参阅一下。</p>
<h2 id="Flyway如何工作的"><a href="#Flyway如何工作的" class="headerlink" title="Flyway如何工作的?"></a>Flyway如何工作的?</h2><p>Flyway对数据库进行版本管理主要由Metadata表和6种命令完成，Metadata主要用于记录元数据，每种命令功能和解决的问题范围不一样，以下分别对metadata表和这些命令进行阐述，其中的示意图都来自Flyway的官方文档。</p>
<h4 id="Metadata-Table"><a href="#Metadata-Table" class="headerlink" title="Metadata Table"></a>Metadata Table</h4><p>Flyway中最核心的就是用于记录所有版本演化和状态的Metadata表，在Flyway首次启动时会创建默认名为<code>SCHEMA_VERSION</code>的元数据表，其表结构为(以MySQL为例)：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">version_rank</td>
<td style="text-align:center">int(11)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">MUL</td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">installed_rank</td>
<td style="text-align:center">int(11)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">MUL</td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">version</td>
<td style="text-align:center">varchar(50)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">description</td>
<td style="text-align:center">varchar(200)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">type</td>
<td style="text-align:center">varchar(20)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">script</td>
<td style="text-align:center">varchar(1000)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">checksum</td>
<td style="text-align:center">int(11)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">installed_by</td>
<td style="text-align:center">varchar(100)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">installed_on</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
</tr>
<tr>
<td style="text-align:center">execution_time</td>
<td style="text-align:center">int(11)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">success</td>
<td style="text-align:center">tinyint(1)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">MUL</td>
<td style="text-align:center">NULL</td>
</tr>
</tbody>
</table>
<p>Flyway官网上提供了一个很清晰的示例<a href="https://flywaydb.org/getstarted/how" target="_blank" rel="external">How Flyway works</a>，可以参阅一下。</p>
<h4 id="Migrate"><a href="#Migrate" class="headerlink" title="Migrate"></a>Migrate</h4><p>Migrate是指把数据库Schema迁移到最新版本，是Flyway工作流的核心功能，Flyway在Migrate时会检查Metadata(元数据)表，如果不存在会创建Metadata表，Metadata表主要用于记录版本变更历史以及Checksum之类的。<br><img src="/assets/flyway-in-practice/command_migrate.png" alt=""></p>
<p>Migrate时会扫描指定文件系统或Classpath下的Migrations(可以理解为数据库的版本脚本)，并且会逐一比对Metadata表中的已存在的版本记录，如果有未应用的Migrations，Flyway会获取这些Migrations并按次序Apply到数据库中，否则不需要做任何事情。另外，通常在应用程序启动时应默认执行Migrate操作，从而避免程序和数据库的不一致性。</p>
<h4 id="Clean"><a href="#Clean" class="headerlink" title="Clean"></a>Clean</h4><p>Clean相对比较容易理解，即清除掉对应数据库Schema中的所有对象，包括表结构，视图，存储过程，函数以及所有的数据等都会被清除。<br><img src="/assets/flyway-in-practice/command_clean.png" alt=""></p>
<p>Clean操作在开发和测试阶段是非常有用的，它能够帮助快速有效地更新和重新生成数据库表结构，但特别注意的是：不应在Production的数据库上使用！</p>
<h4 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h4><p>Info用于打印所有Migrations的详细和状态信息，其实也是通过Metadata表和Migrations完成的，下图很好地示意了Info打印出来的信息。<br><img src="/assets/flyway-in-practice/command_info.png" alt=""></p>
<p>Info能够帮助快速定位当前的数据库版本，以及查看执行成功和失败的Migrations。</p>
<h4 id="Validate"><a href="#Validate" class="headerlink" title="Validate"></a>Validate</h4><p>Validate是指验证已经Apply的Migrations是否有变更，Flyway是默认是开启验证的。<br><img src="/assets/flyway-in-practice/command_validate.png" alt=""></p>
<p>Validate原理是对比Metadata表与本地Migrations的Checksum值，如果值相同则验证通过，否则验证失败，从而可以防止对已经Apply到数据库的本地Migrations的无意修改。</p>
<h4 id="Baseline"><a href="#Baseline" class="headerlink" title="Baseline"></a>Baseline</h4><p>Baseline针对已经存在Schema结构的数据库的一种解决方案，即实现在非空数据库中新建Metadata表，并把Migrations应用到该数据库。<br><img src="/assets/flyway-in-practice/command_baseline.png" alt=""></p>
<p>Baseline可以应用到特定的版本，这样在已有表结构的数据库中也可以实现添加Metadata表，从而利用Flyway进行新Migrations的管理了。</p>
<h4 id="Repair"><a href="#Repair" class="headerlink" title="Repair"></a>Repair</h4><p>Repair操作能够修复Metadata表，该操作在Metadata表出现错误时是非常有用的。<br><img src="/assets/flyway-in-practice/command_repair.png" alt=""></p>
<p>Repair会修复Metadata表的错误，通常有两种用途：</p>
<ul>
<li>移除失败的Migration记录，该问题只是针对不支持DDL事务的数据库。</li>
<li>重新调整已经应用的Migratons的Checksums值，比如：某个Migratinon已经被应用，但本地进行了修改，又期望重新应用并调整Checksum值，不过尽量不要这样操作，否则可能造成其它环境失败。</li>
</ul>
<h2 id="如何使用Flyway"><a href="#如何使用Flyway" class="headerlink" title="如何使用Flyway?"></a>如何使用Flyway?</h2><p>这里将主要关注在Gradle和Spring Boot中集成并使用Flyway，数据库通常会采用MySQL、PostgreSQL、H2或Hsql等。</p>
<h4 id="正确创建Migrations"><a href="#正确创建Migrations" class="headerlink" title="正确创建Migrations"></a>正确创建Migrations</h4><p><strong>Migrations</strong>是指Flyway在更新数据库时是使用的版本脚本，比如：一个基于Sql的Migration命名为<code>V1__init_tables.sql</code>，内容即是创建所有表的sql语句，另外，Flyway也支持基于Java的Migration。Flyway加载Migrations的默认Locations为<code>classpath:db/migration</code>，也可以指定<code>filesystem:/project/folder</code>，其加载是在Runtime自动递归地执行的。<br><img src="/assets/flyway-in-practice/sql_migration_base_dir.png" alt=""></p>
<p>除了需要指定Location外，Flyway对Migrations的扫描还必须遵从一定的命名模式，Migration主要分为两类：Versioned和Repeatable。</p>
<ul>
<li><p><strong>Versioned migrations</strong><br>一般常用的是Versioned类型，用于版本升级，每一个版本都有一个唯一的标识并且只能被应用一次，并且不能再修改已经加载过的Migrations，因为Metadata表会记录其Checksum值。其中的version标识版本号，由一个或多个数字构成，数字之间的分隔符可以采用点或下划线，在运行时下划线其实也是被替换成点了，每一部分的前导零会被自动忽略。</p>
</li>
<li><p><strong>Repeatable migrations</strong><br>Repeatable是指可重复加载的Migrations，其每一次的更新会影响Checksum值，然后都会被重新加载，并不用于版本升级。对于管理不稳定的数据库对象的更新时非常有用。Repeatable的Migrations总是在Versioned之后按顺序执行，但开发者必须自己维护脚本并且确保可以重复执行，通常会在sql语句中使用<code>CREATE OR REPLACE</code>来保证可重复执行。</p>
</li>
</ul>
<p>默认情况下基于Sql的Migration文件的命令规则如下图所示：<br><img src="/assets/flyway-in-practice/sql_migration_naming.png" alt=""></p>
<p>其中的文件名由以下部分组成，除了使用默认配置外，某些部分还可自定义规则。</p>
<ul>
<li>prefix: 可配置，前缀标识，默认值<code>V</code>表示Versioned，<code>R</code>表示Repeatable</li>
<li>version: 标识版本号，由一个或多个数字构成，数字之间的分隔符可用点<code>.</code>或下划线<code>_</code></li>
<li>separator: 可配置，用于分隔版本标识与描述信息，默认为两个下划线<code>__</code></li>
<li>description: 描述信息，文字之间可以用下划线或空格分隔</li>
<li>suffix: 可配置，后续标识，默认为<code>.sql</code></li>
</ul>
<p>另外，关于如何使用基于Java的Migrations，有兴趣可以参考<a href="https://flywaydb.org/documentation/migration/java" target="_blank" rel="external">Java-based migrations</a>。</p>
<h4 id="支持的数据库"><a href="#支持的数据库" class="headerlink" title="支持的数据库"></a>支持的数据库</h4><p>目前Flyway支持的数据库还是挺多的，包括：Oracle, SQL Server, SQL Azure, DB2, DB2 z/OS, MySQL(including Amazon RDS), MariaDB, Google Cloud SQL, PostgreSQL(including Amazon RDS and Heroku), Redshift, Vertica, H2, Hsql, Derby, SQLite, SAP HANA, solidDB, Sybase ASE and Phoenix。<br>目前来说，个人用得比较多的数据库是<a href="https://flywaydb.org/documentation/database/postgresql" target="_blank" rel="external">PostgreSQL</a>、<a href="https://flywaydb.org/documentation/database/mysql" target="_blank" rel="external">MySQL</a>、<a href="https://flywaydb.org/documentation/database/h2" target="_blank" rel="external">H2</a>和<a href="https://flywaydb.org/documentation/database/hsql" target="_blank" rel="external">Hsql</a>，针对每种数据库的<code>flyway.url</code>示例配置为：<br><figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostgreSQL</span></span><br><span class="line"><span class="attribute">flyway</span>.url = jdbc:postgresql://localhost:5432/postgres?currentSchema=myschema</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL</span></span><br><span class="line"><span class="attribute">flyway</span>.url = jdbc:mysql://localhost:3306/testdb?serverTimezone=UTC&amp;useSSL=true</span><br><span class="line"></span><br><span class="line"><span class="comment"># H2</span></span><br><span class="line"><span class="attribute">flyway</span>.url = jdbc:h2:./.tmp/testdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hsql</span></span><br><span class="line"><span class="attribute">flyway</span>.url = jdbc:hsqldb:hsql//localhost:1476/testdb</span><br></pre></td></tr></table></figure></p>
<h4 id="Flyway命令行"><a href="#Flyway命令行" class="headerlink" title="Flyway命令行"></a>Flyway命令行</h4><p>Flyway的命令行工具支持直接在命令行中运行<code>Migrate</code>, <code>Clean</code>, <code>Info</code>, <code>Validate</code>, <code>Baseline</code>和<code>Repair</code>6种命令，不需要借助其他Build工具，不需要应用程序运行在JVM中，只需要单纯的命令行即可，但需要根据不同的操作系统<a href="https://flywaydb.org/documentation/commandline/" target="_blank" rel="external">下载</a>并安装该命令行工具。Flyway会依次搜索以下配置文件，越靠后的配置会覆盖靠前的配置：</p>
<ul>
<li><install-dir>/conf/flyway.conf</install-dir></li>
<li><user-home>/flyway.conf</user-home></li>
<li><current-dir>/flyway.conf</current-dir></li>
</ul>
<p>一个典型Flyway项目示例目录结构如下：<br><img src="/assets/flyway-in-practice/cli_directory_structure.png" alt=""></p>
<p>更多关于Flyway命令行使用可以参考<a href="https://flywaydb.org/documentation/commandline/migrate" target="_blank" rel="external">Flyway Command-line</a>。</p>
<h4 id="在Gradle中的应用"><a href="#在Gradle中的应用" class="headerlink" title="在Gradle中的应用"></a>在Gradle中的应用</h4><p>首先需要在Gradle中引入Flyway插件，通常有两种方式：</p>
<ul>
<li><p>方式一：采用buildscript依赖方式。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span>(<span class="string">"org.flywaydb:flyway-gradle-plugin:4.0.3"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">apply plugin: <span class="string">'org.flywaydb.flyway'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二（推荐）：采用DSL方式引用Plugins。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">"org.flywaydb.flyway"</span> version <span class="string">"4.0.3"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>而在Gradle中配置Flyway Properties有两种方式：</p>
<ul>
<li><p>方式一：在<code>build.gradle</code>中配置Flyway Properties。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flyway &#123;</span><br><span class="line">	url = jdbc:h2:.<span class="regexp">/.tmp/</span>testdb</span><br><span class="line">	user = sa</span><br><span class="line">	password = </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 或者写成：</span><br><span class="line"><span class="keyword">project</span>.ext[<span class="string">'flyway.url'</span>] = <span class="string">'jdbc:h2:./.tmp/testdb'</span></span><br><span class="line"><span class="keyword">project</span>.ext[<span class="string">'flyway.user'</span>] = <span class="string">'sa'</span></span><br><span class="line"><span class="keyword">project</span>.ext[<span class="string">'flyway.password'</span>] = <span class="string">''</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：在<code>gradle.properties</code>中配置Flyway Properties。</p>
<figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flyway</span>.url = jdbc:h2:./.tmp/testdb</span><br><span class="line"><span class="attribute">flyway</span>.user = sa</span><br><span class="line"><span class="attribute">flyway</span>.password =</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果期望在运行Gradle Clean/Build Tasks时自动执行Flyway的某些任务，可以设置<code>dependsOn</code>，若不期望隐式执行Flyway任务，可以不配置。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clean.dependsOn flywayRepair  # To repair the Flyway metadata table</span><br><span class="line">build.dependsOn flywayMigrate  # To migrate the schema to the latest version</span><br></pre></td></tr></table></figure></p>
<p>另外，其它Tasks：<code>flywayInfo</code>, <code>flywayValidate</code>, <code>flywayBaseline</code>分别对应到Flyway的命令。在使用Spring Boot时，运行<code>./gradlew bootRun</code>会自动检查并加载最新的db.migration脚本。</p>
<p><strong>特别注意：</strong>在Production环境中不应执行<code>./gradlew flywayClean</code>，除非你知道自己的行为和目的，因为该命令会清除所有的数据库对象，相当危险。</p>
<p>更多关于Flyway在Gradle中的使用请参阅<a href="https://flywaydb.org/documentation/gradle/migrate" target="_blank" rel="external">Flyway Gradle Plugin</a>。</p>
<h4 id="与Spring-Boot集成"><a href="#与Spring-Boot集成" class="headerlink" title="与Spring Boot集成"></a>与Spring Boot集成</h4><p>在Spring Boot中，如果加入Flyway的依赖，则会<u>自动引用Flyway并使用默认值</u>，但可以修改并配置<a href="https://github.com/spring-projects/spring-boot/tree/v1.4.0.RELEASE/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/flyway/FlywayProperties.java" target="_blank" rel="external">FlywayProperties</a>。<br><figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flyway</span>.baseline-description= # The description to tag an existing schema with when executing baseline.</span><br><span class="line"><span class="attribute">flyway</span>.baseline-version=1 # Version to start migration.</span><br><span class="line"><span class="attribute">flyway</span>.baseline-<span class="literal">on</span>-migrate=false # Whether to execute migration against a non-empty schema with no metadata table</span><br><span class="line"><span class="attribute">flyway</span>.check-location=false # Check that migration scripts location exists.</span><br><span class="line"><span class="attribute">flyway</span>.clean-<span class="literal">on</span>-validation-error=false # will clean <span class="literal">all</span> objects. Warning! Do NOT enable in production!</span><br><span class="line"><span class="attribute">flyway</span>.enabled=true # Enable flyway.</span><br><span class="line"><span class="attribute">flyway</span>.encoding=UTF-8 # The encoding of migrations.</span><br><span class="line"><span class="attribute">flyway</span>.ignore-failed-future-migration=true # Ignore future migrations when reading the metadata table.</span><br><span class="line"><span class="attribute">flyway</span>.init-sqls= # SQL statements to execute to initialize a connection immediately after obtaining it.</span><br><span class="line"><span class="attribute">flyway</span>.locations=classpath:db/migration # locations of migrations scripts.</span><br><span class="line"><span class="attribute">flyway</span>.out-of-order=false # Allows migrations to be run <span class="string">"out of order"</span>.</span><br><span class="line"><span class="attribute">flyway</span>.placeholder-prefix=  # The prefix of every placeholder.</span><br><span class="line"><span class="attribute">flyway</span>.placeholder-replacement=true # Whether placeholders should be replaced.</span><br><span class="line"><span class="attribute">flyway</span>.placeholder-suffix=&#125; # The suffix of every placeholder.</span><br><span class="line"><span class="attribute">flyway</span>.placeholders.*= # Placeholders to replace in Sql migrations.</span><br><span class="line"><span class="attribute">flyway</span>.schemas= # Default schema of the connection and updating</span><br><span class="line"><span class="attribute">flyway</span>.sql-migration-prefix=V # The file name prefix for Sql migrations</span><br><span class="line"><span class="attribute">flyway</span>.sql-migration-separator=__ # The file name separator for Sql migrations</span><br><span class="line"><span class="attribute">flyway</span>.sql-migration-suffix=.sql # The file name suffix for Sql migrations</span><br><span class="line"><span class="attribute">flyway</span>.table=schema_version # The name of Flyway's metadata table.</span><br><span class="line"><span class="attribute">flyway</span>.url= # JDBC url of the database to migrate. If not set, the primary configured data source is used.</span><br><span class="line"><span class="attribute">flyway</span>.user= # Login user of the database to migrate. If not set, use spring.datasource.username value.</span><br><span class="line"><span class="attribute">flyway</span>.password= # JDBC password if you want Flyway to create its own DataSource.</span><br><span class="line"><span class="attribute">flyway</span>.validate-<span class="literal">on</span>-migrate=true # Validate sql migration CRC32 checksum in classpath.</span><br></pre></td></tr></table></figure></p>
<p>若使用Gradle，通常在<code>build.gradle</code>引入<code>org.flywaydb:flyway-core:4.0.3</code>依赖后即可使用。可能会有以下几种需求：</p>
<ul>
<li><p>在本地Run和Tests都会使用内存数据库，其中的<code>spring.jpa.hibernate.ddl-auto</code>都设置为<code>validate</code>，Schema不需要Hibernate自动生成，并期望使用Flyway，而在线上环境会使用真实数据库，并不期望使用Flyway，如何实现呢？<br><strong>解决方案：</strong>可以在<code>common.properties</code>中配置<code>flyway.enabled=false</code>，然后在local或dev的配置中启用Flyway即可。通常推荐使用此模式，毕竟可以对不同的环境进行控制，另外本地Run不会依赖真实数据库，又能保证数据库Schema是按脚本创建的。</p>
</li>
<li><p>在运行Tests会使用内存数据库，有单独的配置文件，不使用Flyway，而在本地bootRun时会使用真实数据库，使用Flyway，毕竟不想每次Schema改后都在本地手动去执行脚本，如何实现？<br><strong>解决方案：</strong>设置<code>bootRun.dependsOn</code>动态添加Flyway的依赖即可：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addFlywayDenpendency &#123;</span><br><span class="line">	<span class="keyword">doLast</span> &#123;</span><br><span class="line">		<span class="keyword">dependencies</span> &#123;</span><br><span class="line">			<span class="keyword">compile</span>(<span class="string">'org.flywaydb:flyway-core:4.0.3'</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bootRun.dependsOn=addFlywayDenpendency</span><br></pre></td></tr></table></figure>
</li>
<li><p>若项目有多个团队同时开发不同的功能，需要新建多个分支，并且都会涉及到数据库Schema更改，当后期Merge时，Migration的版本如何控制并且不会产生数据库更改的冲突呢？<br><strong>解决方案：</strong>如果两个分支的数据库更改有冲突，要么最初数据库设计不合理，要么目前数据库更改不合理，所以需要团队进行全局考虑和协调。而针对数据库在同一段时间有修改，但不会造成冲突的情况，通常实际项目中主要存在这样的情况，那可以设置<code>flyway.out-of-order=true</code>，这样允许当v1和v3已经被应用后，v2出现时同样也可以被应用。其实在本地使用内存数据库不会存在该问题，因为数据库所有对象会自动清除掉，而在local或dev中使用真实数据库时可遇到这样的问题，因此需要注意一下了。<br>另外，值得一提的是Flyway的参数<code>ignore-failed-future-migration</code>默认为<code>true</code>，使用情形为：当Rollback数据库更改到旧版本，而metadata表中已存在了新版本时，Flyway会忽略此错误，只会显示警告信息。</p>
</li>
</ul>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>总得来说，Flyway可以有效改善数据库版本管理方式，如果项目中还未使用，不防尝试一下。如果有兴趣，也可以关注<a href="http://mybatis.github.io/migrations/" target="_blank" rel="external">MyBatis Migration</a>，功能支持没有Flyway多，属于更轻量级的数据库版本管理工具。如果在使用过程中遇到了问题或坑，欢迎留言一起交流讨论。</p>
<hr>
<p>References</p>
<ul>
<li><a href="https://flywaydb.org/documentation/" target="_blank" rel="external">Flyway Documentation</a></li>
<li><a href="https://flywaydb.org/documentation/gradle/" target="_blank" rel="external">Gradle Plugin: Flyway</a></li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html" target="_blank" rel="external">Spring Common application properties</a></li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-execute-flyway-database-migrations-on-startup" target="_blank" rel="external">Execute Flyway database migrations on startup</a></li>
</ul>

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Flyway/">Flyway</a> <a class="tag tag--primary tag--small t-link" href="/tags/Gradle/">Gradle</a> <a class="tag tag--primary tag--small t-link" href="/tags/Migration/">Migration</a> <a class="tag tag--primary tag--small t-link" href="/tags/Spring-Boot/">Spring Boot</a> <a class="tag tag--primary tag--small t-link" href="/tags/数据库/">数据库</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/using-stubby4j/"  data-tooltip="在集成测试中使用Stubby4J">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/sonarqube-by-step/" data-tooltip="代码质量管理SonarQube">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share bdsharebuttonbox">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-copy" target="new" data-cmd="copy"></a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-qq" target="new" href="#" data-cmd="sqq"></a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-wechat" target="new" href="#" data-cmd="weixin"></a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-weibo" target="new" href="#" data-cmd="tsina"></a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>

<script>
    window._bd_share_config = {
        "common": {
            "bdSnsKey": {},
            "bdText": "",
            "bdMini": "2",
            "bdMiniList": false,
            "bdPic": "",
            "bdStyle": "2",
            "bdSize": "24"
        }, "share": {}
    };
    with (document)0[(getElementsByTagName('head')[0] || body)
            .appendChild(createElement('script'))
            .src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
</script>


        
            
                <div id="ds-thread" class="ds-thread" data-thread-key="flyway-in-practice/"
     data-title="快速掌握和使用Flyway" data-url="http://blog.waterstrong.me/flyway-in-practice/">
</div>

            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights left">
        &copy; 2017 <a href="https://github.com/waterstrong" target="_blank">Waterstrong</a>
    </span>
    
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span class="visit">
    <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit">Site Visited:
            <span id="busuanzi_value_site_uv"></span>
        </span>
    </span>
    <span>, </span>
    <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">Page Visited:
            <span id="busuanzi_value_page_pv"></span>
        </span>
    </span>
</span>

    <span class="copyrights right">
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="6">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/using-stubby4j/"  data-tooltip="在集成测试中使用Stubby4J">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/sonarqube-by-step/" data-tooltip="代码质量管理SonarQube">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share bdsharebuttonbox">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-copy" target="new" data-cmd="copy"></a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-qq" target="new" href="#" data-cmd="sqq"></a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-wechat" target="new" href="#" data-cmd="weixin"></a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default fa fa-weibo" target="new" href="#" data-cmd="tsina"></a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>

<script>
    window._bd_share_config = {
        "common": {
            "bdSnsKey": {},
            "bdText": "",
            "bdMini": "2",
            "bdMiniList": false,
            "bdPic": "",
            "bdStyle": "2",
            "bdSize": "24"
        }, "share": {}
    };
    with (document)0[(getElementsByTagName('head')[0] || body)
            .appendChild(createElement('script'))
            .src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
</script>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="6">
    <ul class="share-options bdsharebuttonbox">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="#" data-cmd="tsina">
                <i class="fa fa-weibo"></i>Share on Sina Weibo
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="#" data-cmd="weixin">
                <i class="fa fa-wechat"></i>Share on Wechat
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="#" data-cmd="sqq">
                <i class="fa fa-qq"></i>Share on QQ
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="#" data-cmd="fbook">
                <i class="fa fa-facebook-official"></i>Share on Facebook
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="#" data-cmd="linkedin">
                <i class="fa fa-linkedin"></i>Share on LinkedIn
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="#" data-cmd="twi">
                <i class="fa fa-twitter"></i>Share on Twitter
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/head.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Waterstrong</h4>
        
            <div id="about-card-bio"><p>I’m Waterstrong! The man who has made up his mind to win will never say “Impossible” !<br> Stay quiet, run wild !<br> <a href="/about">More about…</a></p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Dev Consultant</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Chengdu, China
            </div>
        
    </div>
</div>

        <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-close"></i></span>
            <a href="https://algolia.com" target="_blank" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    autofocus="autofocus"/>
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/cpp-singleton/">
                            <img class="media-image" src="/assets/common-pic/city2.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/cpp-singleton/">
                            <h3 class="media-heading">C++单例模式实现</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 28, 2011
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>之前遇到关于C++实现单例模式的问题，并非那么简单，主要有部分问题要解决，现在和大家分享一下。我们都知道在Java/C#中实现起来相当容易，但C++确实是有点绕，不过这正是其魅力所在，现在直接上代码，有注释。<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/directshow-graphics/">
                            <img class="media-image" src="/assets/common-pic/vintage1.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/directshow-graphics/">
                            <h3 class="media-heading">DirectShow获取摄像头图像</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 28, 2011
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/mybatis-in-practice/">
                            <img class="media-image" src="/assets/mybatis-practice/mybatis.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/mybatis-in-practice/">
                            <h3 class="media-heading">MyBatis入门与实践</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Oct 12, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/code-your-ioc/">
                            <img class="media-image" src="/assets/ioc-practice/di.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/code-your-ioc/">
                            <h3 class="media-heading">如何实现一个简单的IoC容器</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 20, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/mysql-case-sensitive-linux/">
                            <img class="media-image" src="/assets/mysql-case/mysql.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/mysql-case-sensitive-linux/">
                            <h3 class="media-heading">MySQL在Linux下默认区分大小写</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 20, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>前段时间遇到一个Hibernate/JPA自动映射MySQL Schema时报错问题，然后查了一下官方文档，原来是MySQL在Linux下默认区分大小写导致的，大致了解了一下，主要涉及两个变量lower_case_file_system和lower_case_table_names。<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/aspect-oriented-programming/">
                            <img class="media-image" src="/assets/aop/aop_diagram.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/aspect-oriented-programming/">
                            <h3 class="media-heading">AOP面向切面编程</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 20, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/transactional-mechanism-protocol/">
                            <img class="media-image" src="/assets/transactional-mp/XA_two_phase_commit.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/transactional-mechanism-protocol/">
                            <h3 class="media-heading">事务处理机制与协议</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Feb 4, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/aws-ec2-basic/">
                            <img class="media-image" src="/assets/aws-ec2-basic/aws_homepage.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/aws-ec2-basic/">
                            <h3 class="media-heading">AWS EC2入门篇</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 11, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/aws-ec2-vpn/">
                            <img class="media-image" src="/assets/aws-ec2-vpn/6s_test_vpn.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/aws-ec2-vpn/">
                            <h3 class="media-heading">AWS EC2搭建VPN服务器</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 13, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/concourse-ci/">
                            <img class="media-image" src="/assets/concourse-ci/pipeline_cover.png" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://blog.waterstrong.me/concourse-ci/">
                            <h3 class="media-heading">Concourse CI 介绍</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 19, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="no post found"
                data-message-one="1 post found"
                data-message-other="{n} posts found">
                29 posts found
            </p>
        </div>
    </div>
</div>
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-ato8ax1yi8iylbxgfqfwxcwm2gwpvpwqc7bueqjhvimh23hezvscqo7rsjix.min.js"></script>
<!--SCRIPTS END-->

    
        <script type="text/javascript">
            var duoshuoQuery = {short_name:'waterstrong'};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
    



    </body>
</html>
